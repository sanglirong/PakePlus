import{d as e,cd as a,u as t,ad as l,r as o,a0 as n,n as i,k as s,e as r,o as d,p as m,l as c,a4 as p,dj as b,g as u,t as f,j as g,ae as y,q as h,i as F,m as T,v as k,F as D,V as _,ah as v}from"./index-920db443.js";import{q as I,r as S,t as w}from"./visualDev-8f54ab4b.js";import{g as L}from"./dataSource-ed26da12.js";import{a as C}from"./dataModel-ea807f46.js";import{u as x,b as N,B as O}from"./index-143f5813.js";import{u as j,B as R}from"./useForm-1d28ee0b.js";import"./componentMap-c91676b4.js";import{f as P}from"./formValidate-c8ab8d29.js";import{_ as V}from"./TableModal.vue_vue_type_script_setup_true_lang-34dab00f.js";import{_ as J}from"./FormGenerator.vue_vue_type_script_setup_true_lang-948e37f5.js";import{_ as M}from"./BasicColumnDesign.vue_vue_type_style_index_0_lang-4969526a.js";import{V as q}from"./index-c37d2476.js";const A={class:"jnpf-full-modal-header"},U={class:"header-title"},z={key:0,class:"header-txt"},B={class:"header-txt"},$=["title"],H=e({__name:"Form",emits:["register","reload"],setup(e,{emit:H}){const G=H,[K,{setFieldsValue:Q,getFieldsValue:W,resetFields:E,validate:X,updateSchema:Y}]=j({schemas:[{field:"fullName",label:"表单名称",component:"Input",componentProps:{placeholder:"请输入",maxlength:100},rules:[{required:!0,trigger:"blur",message:"必填"}]},{field:"enCode",label:"表单编码",component:"Input",componentProps:{placeholder:"请输入",maxlength:50},rules:[{required:!0,trigger:"blur",message:"必填"},{validator:P("enCode"),trigger:"blur"}]},{field:"category",label:"表单分类",component:"Select",componentProps:{placeholder:"请选择",showSearch:!0},rules:[{required:!0,trigger:"change",message:"必填"}]},{field:"sortCode",label:"表单排序",defaultValue:0,component:"InputNumber",componentProps:{min:0,max:999999}},{field:"description",label:"表单说明",component:"Textarea",componentProps:{placeholder:"请输入"}},{field:"dbLinkId",label:"数据连接",defaultValue:"0",component:"Select",componentProps:{placeholder:"请选择",allowClear:!1,showSearch:!0,fieldNames:{options:"children"},onChange:function(){re.tables=[]}}}]}),[Z,{openModal:ee}]=x(),[ae,{closeModal:te,changeLoading:le}]=N((function(e){re.isReload=!1,re.activeStep=0,re.loading=!0,re.tables=[],re.defaultTable=[],re.errorList=[],re.formData=null,re.columnData=null,re.appColumnData=null,Y([{field:"category",componentProps:{options:e.categoryList}}]),void L().then((e=>{let a=e.data.list||[];a=a.filter((e=>e.children&&e.children.length)),a[0]&&a[0].children&&a[0].children.length&&(a[0]=a[0].children[0]),delete a[0].children,re.dbOptions=a,Y([{field:"dbLinkId",componentProps:{options:re.dbOptions}}])})),le(!0),E(),re.dataForm.id=e.id,re.dataForm.id?I(re.dataForm.id).then((e=>{re.dataForm=e.data,re.maxStep=4==re.dataForm.webType?1:2,Q(re.dataForm),re.formData=re.dataForm.formData&&JSON.parse(re.dataForm.formData),re.columnData=re.dataForm.columnData&&JSON.parse(re.dataForm.columnData),re.appColumnData=re.dataForm.appColumnData&&JSON.parse(re.dataForm.appColumnData),re.tables=re.dataForm.tables?JSON.parse(re.dataForm.tables):[],re.defaultTable=re.dataForm.tables?JSON.parse(re.dataForm.tables):[],async function(){if(!re.tables.length)return re.loading=!1,void i((()=>Ce()));re.dataForm.dbLinkId=re.dataForm.dbLinkId||"0";const e=re.dataForm.type,a=3==e||4==e||5==e?"1":"0";for(let t=0;t<re.tables.length;t++){const e=(await C(re.dataForm.dbLinkId,re.tables[t].table,a)).data.list;re.tables[t].fields=e,"1"==re.tables[t].typeId&&(re.mainTableFields=re.tables[t].fields,re.relationTable=re.tables[t].table)}re.loading=!1,i((()=>Ce()))}(),le(!1)})):(re.dataForm.type=e.type,re.dataForm.webType=e.webType||2,re.maxStep=4==re.dataForm.webType?1:2,re.loading=!1,le(!1))})),{createMessage:oe,createConfirm:ne}=v(),ie=a(),{t:se}=t(),re=l({activeStep:0,maxStep:2,loading:!1,btnLoading:!1,relationTable:!1,mainTableFields:[],dbOptions:[],tables:[],defaultTable:[],dataForm:{id:"",fullName:"",enCode:"",type:1,webType:2,dbLinkId:"0",sortCode:0,state:1,category:"",description:"",tables:"",interfaceId:"",interfaceName:"",interfaceParam:""},formData:null,columnData:null,appColumnData:null,dbType:"MySQL",isReload:!1,errorList:[]}),de=o(null),me=o(null),ce=o(null),{activeStep:pe,maxStep:be,loading:ue,btnLoading:fe,tables:ge,mainTableFields:ye,dbType:he,formData:Fe,columnData:Te,appColumnData:ke,dataForm:De,errorList:_e}=n(re),ve=[{title:"类别",dataIndex:"typeId",key:"typeId",width:65},{title:"表名",dataIndex:"table",key:"table"},{title:"外键字段",dataIndex:"tableField",key:"tableField",width:160},{title:"关联主键",dataIndex:"relationField",key:"relationField",width:160},{title:"操作",dataIndex:"action",key:"action",width:50,fixed:"right"}];function Ie(e){ne({iconType:"warning",title:se("common.tipTitle"),content:"1"==e?"关闭后，将切换为纯表单模式":"开启后，将切换为表单+列表模式",onOk:()=>{re.dataForm.webType=e}})}function Se(){const e=W();if(!e.dbLinkId)return oe.error("请先选择数据库");ee(!0,{dbLinkId:e.dbLinkId})}async function we(e){const a=W(),t=re.dataForm.type,l=3==t||4==t||5==t?"1":"0",o=[];if(re.tables.length){for(let t=0;t<e.length;t++){const n=e[t];if(!re.tables.some((e=>e.table==n.table))){const e=(await C(a.dbLinkId,n.table,l)).data.list,t={relationField:"",relationTable:re.relationTable,table:n.table,tableName:n.tableName,tableField:"",typeId:"0",fields:e};o.push(t)}}re.tables=[...re.tables,...o]}else{for(let t=0;t<e.length;t++){const n=e[t],i=e[0].table,s=0==t?"1":"0",r=(await C(a.dbLinkId,n.table,l)).data.list,d={relationField:"",relationTable:0==t?"":i,table:n.table,tableName:n.tableName,tableField:"",typeId:s,fields:r};o.push(d)}re.relationTable=o[0].table,re.mainTableFields=o[0].fields,re.tables=o}re.loading=!1}function Le(){re.activeStep-=1,0==re.activeStep&&Ne()}async function Ce(){if(re.activeStep<1){const e=await X();if(!e)return;re.dataForm={...re.dataForm,...e},function(){for(let e=0;e<re.dbOptions.length;e++){const a=re.dbOptions[e];if(re.dataForm.dbLinkId===a.id){re.dbType=a.dbType;break}const t=re.dbOptions[e].children||[];for(let e=0;e<t.length;e++)if(re.dataForm.dbLinkId===t[e].id){re.dbType=t[e].dbType;break}}}();const a=re.dataForm.type;if(re.tables.length){if(!function(){let e=!0;for(let a=0;a<re.tables.length;a++){const t=re.tables[a];if("0"==t.typeId){if(!t.tableField){oe.warning(`表${t.table}外键字段不能为空`),e=!1;break}if(!t.relationField){oe.warning(`表${t.table}关联主键不能为空`),e=!1;break}}}return e}())return;const e=re.tables.filter((e=>"0"==e.typeId));ie.setHasTable(!0),ie.setAllTable(re.tables),ie.setSubTable(e),ie.setFormItemList(re.mainTableFields),re.activeStep+=1}else{if(re.defaultTable.length||3==a||4==a)return void oe.warning("请至少选择一个数据表");ie.setHasTable(!1),ie.setAllTable([]),ie.setFormItemList([]),re.activeStep+=1}}else 1===re.activeStep?s(de).getData().then((e=>{re.errorList=e.errorList||[],re.errorList.length?setTimeout((()=>{s(ce)?.setVisible(!0)}),10):(re.formData=e.formData,re.dataForm.formData=re.formData?JSON.stringify(re.formData):null,re.activeStep+=1)})).catch((e=>{e.msg&&oe.warning(e.msg)})):s(me).getData().then((e=>{re.columnData=e.columnData,re.appColumnData=e.appColumnData,re.activeStep+=1})).catch((e=>{e.msg&&oe.warning(e.msg)}))}function xe(e){0==e&&Ne()}function Ne(){re.tables=ie.getAllTable,re.mainTableFields=ie.getFormItemList}function Oe(){re.btnLoading=!0;const e={...re.dataForm,tables:JSON.stringify(re.tables),formData:re.formData?JSON.stringify(re.formData):null,columnData:re.columnData?JSON.stringify(re.columnData):null,appColumnData:re.appColumnData?JSON.stringify(re.appColumnData):null};(re.dataForm.id?S:w)(e).then((e=>{oe.success(e.msg),re.btnLoading=!1,re.isReload=!0,re.dataForm.id||(re.dataForm.id=e.data)})).catch((()=>{re.btnLoading=!1}))}function je(e){s(de)?.setTabActiveKey("formAttr"==e?"form":"field"),s(de)?.activeFormItemById(e)}function Re(e){re.errorList=e||[],re.errorList.length&&setTimeout((()=>{s(ce)?.setVisible(!0)}),10)}return(e,a)=>{const t=r("a-tooltip"),l=r("a-step"),o=r("a-steps"),n=r("a-button"),i=r("a-space-compact"),v=r("a-space"),I=r("a-tag"),S=r("jnpf-select"),w=r("a-table"),L=r("a-col"),C=r("a-row");return d(),m(s(O),_(e.$attrs,{onRegister:s(ae),defaultFullscreen:"",footer:null,closable:!1,keyboard:!1,class:"jnpf-full-modal full-modal designer-modal","destroy-on-close":""}),{title:c((()=>[p("div",A,[p("div",U,[a[4]||(a[4]=p("img",{src:b,class:"header-logo"},null,-1)),a[5]||(a[5]=p("span",{class:"header-dot"},null,-1)),s(pe)?(d(),m(t,{key:1,title:s(De).fullName},{default:c((()=>[p("p",B,f(s(De).fullName),1)])),_:1},8,["title"])):(d(),u("p",z,"在线开发"))]),g(o,{current:s(pe),"onUpdate:current":a[0]||(a[0]=e=>y(pe)?pe.value=e:null),type:"navigation",size:"small",onChange:xe,class:"header-steps"},{default:c((()=>[g(l,{title:"基础设计"}),g(l,{title:"表单设计",disabled:s(pe)<=1},null,8,["disabled"]),s(be)>=2?(d(),m(l,{key:0,title:"列表设计",disabled:""})):h("",!0)])),_:1},8,["current"]),g(v,{class:"options",size:10},{default:c((()=>[F(g(n,{shape:"round",type:"warning",onClick:a[1]||(a[1]=e=>Ie(1))},{default:c((()=>[T(f(s(se)("common.closeList")),1)])),_:1},512),[[k,2==s(pe)&&2==s(De).webType]]),1==s(pe)?(d(),m(s(q),{key:0,ref_key:"validatePopoverRef",ref:ce,errorList:s(_e),onSelect:je},null,8,["errorList"])):h("",!0),g(i,{block:""},{default:c((()=>[g(n,{shape:"round",onClick:Le,disabled:s(pe)<=0||s(fe)},{default:c((()=>[T(f(s(se)("common.prev")),1)])),_:1},8,["disabled"]),g(n,{shape:"round",onClick:Ce,disabled:s(pe)>=s(be)||s(ue)||s(fe)},{default:c((()=>[T(f(s(se)("common.next")),1)])),_:1},8,["disabled"])])),_:1}),g(n,{shape:"round",type:"primary",onClick:a[2]||(a[2]=e=>async function(){if(re.activeStep<1){const e=re.dataForm.type;if(!re.tables.length&&(re.defaultTable.length||3==e||4==e))return oe.warning("请至少选择一个数据表");const a=await X();if(!a)return;re.dataForm={...re.dataForm,...a},Oe()}else if(1===re.activeStep)s(de).getData().then((e=>{re.errorList=e.errorList||[],re.errorList.length?setTimeout((()=>{s(ce)?.setVisible(!0)}),10):(re.formData=e.formData,re.dataForm.formData=re.formData?JSON.stringify(re.formData):null,Oe())})).catch((e=>{e.msg&&oe.warning(e.msg)}));else{if(1==re.dataForm.webType)return Oe();s(me).getData().then((e=>{re.columnData=e.columnData,re.appColumnData=e.appColumnData,Oe()})).catch((e=>{e.msg&&oe.warning(e.msg)}))}}()),disabled:s(ue),loading:s(fe)},{default:c((()=>[T(f(s(se)("common.saveText")),1)])),_:1},8,["disabled","loading"]),g(n,{shape:"round",onClick:a[3]||(a[3]=e=>(te(),void(re.isReload&&G("reload"))))},{default:c((()=>[T(f(s(se)("common.closeText")),1)])),_:1})])),_:1})])])),default:c((()=>[F(g(C,{type:"flex",justify:"center",align:"middle",class:"basic-content"},{default:c((()=>[g(L,{span:12,xxl:10,class:"basic-form"},{default:c((()=>[g(s(R),{onRegister:s(K)},null,8,["onRegister"]),g(w,{"data-source":s(ge),columns:ve,size:"small",pagination:!1,scroll:{x:"max-content"}},{bodyCell:c((({column:e,record:t,index:l})=>["typeId"===e.key?(d(),u(D,{key:0},["1"==t.typeId?(d(),m(I,{key:0,color:"processing"},{default:c((()=>a[6]||(a[6]=[T("主表")]))),_:1,__:[6]})):(d(),m(I,{key:1,color:"warning",onClick:e=>function(e){re.relationTable=e.table,re.mainTableFields=e.fields;for(let a=0;a<re.tables.length;a++)re.tables[a].typeId=re.tables[a].table===e.table?"1":"0",re.tables[a].relationTable=re.tables[a].table===e.table?"":re.relationTable,re.tables[a].relationField="",re.tables[a].tableField=""}(t),style:{cursor:"pointer"},title:"点击设置成主表"},{default:c((()=>a[7]||(a[7]=[T("从表")]))),_:2,__:[7]},1032,["onClick"]))],64)):h("",!0),"table"===e.key?(d(),u("span",{key:1,title:t.tableName||t.table},f(t.table),9,$)):h("",!0),"tableField"===e.key&&"1"!==t.typeId?(d(),m(S,{key:2,value:t.tableField,"onUpdate:value":e=>t.tableField=e,placeholder:"请选择",options:t.fields,"field-names":{value:"field",label:"field"},showSearch:"",class:"!w-144px"},null,8,["value","onUpdate:value","options"])):h("",!0),"relationField"===e.key&&"1"!==t.typeId?(d(),m(S,{key:3,value:t.relationField,"onUpdate:value":e=>t.relationField=e,placeholder:"请选择",options:s(ye),"field-names":{value:"field",label:"field"},showSearch:"",class:"!w-144px"},null,8,["value","onUpdate:value","options"])):h("",!0),"action"===e.key?(d(),m(n,{key:4,class:"action-btn",type:"link",color:"error",onClick:e=>function(e,a){ne({iconType:"warning",title:se("common.tipTitle"),content:"确定要移除当前行?",onOk:()=>{re.tables.splice(a,1),"1"==e.typeId&&re.tables.length&&(re.tables[0].typeId="1",re.tables[0].relationTable="",re.tables[0].tableField="",re.tables[0].relationField="",re.tables[0].relationTable="",re.mainTableFields=re.tables[0].fields,re.relationTable=re.tables[0].table)}})}(t,l),size:"small"},{default:c((()=>a[8]||(a[8]=[T("移除")]))),_:2,__:[8]},1032,["onClick"])):h("",!0)])),emptyText:c((()=>a[9]||(a[9]=[p("p",{class:"ant-table__empty-text"},"点击“新增”可选择1条(单表)或2条以上(多表)，未选择数据表时系统将会自动创建数据表",-1)]))),_:1},8,["data-source"]),p("div",{class:"table-add-action",onClick:Se},[g(n,{type:"link",preIcon:"icon-ym icon-ym-btn-add"},{default:c((()=>a[10]||(a[10]=[T("新增一行")]))),_:1,__:[10]})])])),_:1})])),_:1},512),[[k,!s(pe)]]),1==s(pe)?(d(),m(s(J),{key:0,ref_key:"generatorRef",ref:de,conf:s(Fe),formInfo:s(De),dbType:s(he),onShowValidatePopover:Re},null,8,["conf","formInfo","dbType"])):h("",!0),2==s(pe)?(d(),m(s(M),{key:1,ref_key:"columnDesignRef",ref:me,columnData:s(Te),appColumnData:s(ke),formInfo:s(De),onToggleWebType:Ie},null,8,["columnData","appColumnData","formInfo"])):h("",!0),g(V,{onRegister:s(Z),onSelect:we},null,8,["onRegister"])])),_:1},16,["onRegister"])}}});export{H as _};
