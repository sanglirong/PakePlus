import{u as e,B as t}from"./useTable-dc8c9d84.js";import{e as o,f as n,h as i,g as a,i as r}from"./dataSource-ed26da12.js";import{d as s,ad as l,a0 as c,r as d,u,a7 as p,e as f,o as m,g,a4 as b,j as v,l as C,k as L,m as _,p as h,t as j,q as y,ah as F,a5 as T}from"./index-920db443.js";import{u as w}from"./index-143f5813.js";import R from"./Form-40f32652.js";import"./useForm-1d28ee0b.js";import"./componentMap-c91676b4.js";import"./visualDev-8f54ab4b.js";import"./index.vue_vue_type_script_setup_true_lang-69353133.js";import"./index-9c138ba5.js";import"./ArrowLeftOutlined-3fbf15bc.js";import"./log-2a5f2c26.js";import"./index-999abbee.js";import"./Parser.vue_vue_type_script_setup_true_lang-6ddfe448.js";import"./Item.vue_vue_type_script_setup_true_lang-fef56f78.js";import"./Form.vue_vue_type_script_setup_true_lang-63005a4d.js";import"./createAsyncComponent-7e8f72ac.js";import"./DataLogList.vue_vue_type_script_setup_true_lang-c225eb8c.js";import"./index-0be8277c.js";import"./jquery-6353a699.js";import"./useDefineSetting-7df030ff.js";import"./CustomForm.vue_vue_type_script_setup_true_lang-1aa664f4.js";import"./config-06ca91cd.js";import"./upperFirst-2cd1a2f7.js";import"./useTabs-ceeccdba.js";import"./uniqBy-e868edd7.js";import"./useWindowSizeFn-05f906e2.js";import"./sortable.esm-02d0fe44.js";import"./SettingOutlined-dd6150a2.js";import"./index-1cfe4e28.js";const k={class:"jnpf-content-wrapper"},S={class:"jnpf-content-wrapper-center"},x={class:"jnpf-content-wrapper-content bg-white"},M={class:"p-20px"},O=T(s({name:"systemData-dataSync",__name:"index",setup(s){const T=l({dataRule:{dbConnectionFrom:[{required:!0,message:"数据库连接 From不能为空",trigger:"change"}],dbConnectionTo:[{required:!0,message:"数据库连接 To不能为空",trigger:"change"}]},dataForm:{dbConnectionFrom:"",dbConnectionTo:""},dbOptions:[],configureList:[],beforeConversionList:[],defaultConfigureList:[],convertRuleMap:{},verification:!1,tableLoading:!1,list:[]}),{dataRule:O,dataForm:N,dbOptions:I,list:J,tableLoading:D}=c(T),q=d(),{t:A}=u(),{createMessage:B,createConfirm:K}=F(),[z,{getSelectRowKeys:P,clearSelectedRowKeys:U}]=e({columns:[{title:"表名",dataIndex:"table"},{title:"总数",dataIndex:"sum"},{title:"结果",dataIndex:"result"},{title:"操作",dataIndex:"action",width:100}],useSearchForm:!1,showTableSetting:!1,fetchSetting:{listField:""},pagination:!1,immediate:!1,clickToRowSelect:!1,rowSelection:{type:"checkbox"},rowKey:"table"}),[E,{openModal:G}]=w();function H(){const e=P();if(!e.length)return B.error("请先选择数据");var t={};let o={dbConnectionFrom:T.dataForm.dbConnectionFrom,dbConnectionTo:T.dataForm.dbConnectionTo,dbTableList:e};if(T.configureList&&T.configureList.length){for(var i in T.configureList)t[T.configureList[i].beforeConversion]=T.configureList[i].afterConversion;o={...o,convertRuleMap:t}}K({iconType:"warning",title:A("common.tipTitle"),content:"批量同步，将覆盖您原有表内的数据。请确认操作",onOk:()=>{T.tableLoading=!0,n(o).then((e=>{B.success(e.msg);for(const t in e.data)for(let o=0;o<T.list.length;o++){const n=T.list[o];n.table==t&&(n.result=1==e.data[t]?"成功":"失败")}T.tableLoading=!1,U()})).catch((()=>{T.tableLoading=!1}))}})}function Q(e,t){e.result="";var o={};let n={type:t,dbConnectionFrom:T.dataForm.dbConnectionFrom,dbConnectionTo:T.dataForm.dbConnectionTo,dbTable:e.table};if(T.configureList.length){for(var a in T.configureList)o[T.configureList[a].beforeConversion]=T.configureList[a].afterConversion;n={...n,convertRuleMap:o}}i(n).then((t=>{e.result=t.msg,e.btnLoading=!1})).catch((()=>{e.btnLoading=!1}))}function W(){L(q).validate().then((e=>{if(e.dbConnectionFrom===e.dbConnectionTo)return B.error("数据库连接不能相同"),void(T.list=[]);T.tableLoading=!0,r(T.dataForm).then((e=>{for(var t in T.tableLoading=!1,T.beforeConversionList=[],T.convertRuleMap=e.data.convertRuleMap,T.convertRuleMap)T.beforeConversionList.push({val:t,value:T.convertRuleMap[t]});T.defaultConfigureList=[];for(let o=0;o<T.beforeConversionList.length;o++){const e=T.beforeConversionList[o];T.defaultConfigureList.push({beforeConversion:e.val,afterConversion:e.value[0]}),T.defaultConfigureList[o].afterConversionList=e.value}T.configureList=JSON.parse(JSON.stringify(T.defaultConfigureList)),T.verification=e.data.checkDbFlag,T.list=e.data.tableList;for(let o=0;o<T.list.length;o++)T.list[o].result="",T.list[o].btnLoading=!1})).catch((()=>{T.list=[],T.tableLoading=!1}))}))}function V(){if(!T.verification)return B.error("请验证连接");T.configureList=JSON.parse(JSON.stringify(T.defaultConfigureList)),G(!0,{configureList:T.configureList,beforeConversionList:T.beforeConversionList,convertRuleMap:T.convertRuleMap})}function X(e){T.defaultConfigureList=JSON.parse(JSON.stringify(e))}return p((()=>{a().then((e=>{let t=e.data.list||[];t=t.filter((e=>e.children&&e.children.length)),t[0]&&t[0].children&&t[0].children.length&&(t[0]=t[0].children[0]),delete t[0].children,T.dbOptions=t}))})),(e,n)=>{const i=f("JnpfAlert"),a=f("jnpf-select"),r=f("a-form-item"),s=f("a-button"),l=f("a-form"),c=f("a-tag");return m(),g("div",k,[b("div",S,[b("div",x,[b("div",M,[v(i,{message:"温馨提示：数据同步是由A数据库同步到B数据库。",type:"warning","show-icon":""})]),v(l,{ref_key:"fromRef",ref:q,model:L(N),rules:L(O),labelCol:{style:{width:"140px"}},class:""},{default:C((()=>[v(r,{label:"数据库连接 From",name:"dbConnectionFrom"},{default:C((()=>[v(a,{value:L(N).dbConnectionFrom,"onUpdate:value":n[0]||(n[0]=e=>L(N).dbConnectionFrom=e),"show-search":"",placeholder:"请选择",options:L(I),fieldNames:{options:"children"}},null,8,["value","options"])])),_:1}),v(r,{label:"数据库连接 To",name:"dbConnectionTo"},{default:C((()=>[v(a,{value:L(N).dbConnectionTo,"onUpdate:value":n[1]||(n[1]=e=>L(N).dbConnectionTo=e),"show-search":"",placeholder:"请选择",options:L(I),fieldNames:{options:"children"}},null,8,["value","options"]),v(s,{type:"primary",onClick:W,class:"ml-10px"},{default:C((()=>n[2]||(n[2]=[_("验证连接")]))),_:1,__:[2]}),v(s,{preIcon:"icon-ym icon-ym-btn-add",onClick:V,class:"ml-10px"},{default:C((()=>n[3]||(n[3]=[_("规则配置")]))),_:1,__:[3]})])),_:1})])),_:1},8,["model","rules"]),b("div",{class:"title-content"},[n[4]||(n[4]=b("h2",null,"数据库表",-1)),b("span",{class:"link-text",onClick:H},"批量同步")]),v(L(t),{onRegister:L(z),dataSource:L(J),loading:L(D)},{bodyCell:C((({column:e,record:t})=>["enabledMark"===e.key?(m(),h(c,{key:0,color:1==t.enabledMark?"success":"error"},{default:C((()=>[_(j(1==t.enabledMark?"启用":"禁用"),1)])),_:2},1032,["color"])):y("",!0),"action"===e.key?(m(),h(s,{key:1,type:"link",onClick:e=>function(e){var t={};e.btnLoading=!0,e.result="";let n={dbConnectionFrom:T.dataForm.dbConnectionFrom,dbConnectionTo:T.dataForm.dbConnectionTo,dbTable:e.table};if(T.configureList.length){for(var i in T.configureList)t[T.configureList[i].beforeConversion]=T.configureList[i].afterConversion;n={...n,convertRuleMap:t}}o(n).then((t=>{if(0==t.data)Q(e,t.data);else if(1==t.data)B.warning("初始库表中没有数据"),e.btnLoading=!1;else if(2==t.data||3==t.data){const o=2==t.data?"目标库中该表不存在，是否在目标库中创建该表，并同步数据?":"目标表存在数据,是否自动清除并同步数据?";K({iconType:"warning",title:A("common.tipTitle"),content:o,onOk:()=>{Q(e,t.data)},onCancel(){e.btnLoading=!1}})}})).catch((()=>{e.btnLoading=!1}))}(t),loading:t.btnLoading,size:"small",style:{padding:"0"}},{default:C((()=>n[5]||(n[5]=[_("数据同步")]))),_:2,__:[5]},1032,["onClick","loading"])):y("",!0)])),_:1},8,["onRegister","dataSource","loading"])]),v(R,{onRegister:L(E),onRefresh:X},null,8,["onRegister"])])])}}}),[["__scopeId","data-v-0800d360"]]);export{O as default};
