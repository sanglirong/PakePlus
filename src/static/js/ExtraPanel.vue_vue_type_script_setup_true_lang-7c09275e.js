import{d as e,u as t,aw as a,r as i,ad as l,a0 as n,e as s,a9 as o,o as r,p as c,l as m,a4 as d,j as u,k as p,i as f,ab as g,g as v,F as y,h as k,t as _,q as h,dF as I,V as L,n as b,M as x,dD as C,cl as w,e6 as S,m as F,af as D,dv as j,ah as U,a7 as R,e0 as A,dp as T,bC as z,ae as N}from"./index-920db443.js";import{_ as B}from"./RecordTimeList.vue_vue_type_style_index_0_lang-23988eb1.js";import{c as M,d as O,b as H}from"./template-c6142676.js";import{b as E,B as K,u as P}from"./index-143f5813.js";import{y as V}from"./task-ee77df5a.js";import{e as G}from"./emoji-a68b5251.js";import{_ as J}from"./DataLogList.vue_vue_type_script_setup_true_lang-c225eb8c.js";import $ from"./AuxiliaryList-441188d6.js";const Q={class:"transfer__body"},q={class:"transfer-pane left-pane"},W={class:"transfer-pane__tool"},X={class:"transfer-pane__body transfer-pane__body-tab"},Y=["onClick"],Z={class:"selected-item-main"},ee={class:"selected-item-text"},te={class:"name"},ae=["title"],ie={class:"transfer-pane right-pane"},le={class:"transfer-pane__tool"},ne={class:"transfer-pane__body"},se={class:"selected-item-main"},oe={class:"selected-item-text"},re={class:"name"},ce=["title"],me=e({__name:"FlowUserModal",props:{taskId:{type:[String,Number],default:""}},emits:["register","confirm"],setup(e,{emit:x}){const C=e,w=x,{t:S}=t(),F=a(),D=i(F.apiUrl),j=i(null),[U,{changeLoading:R,changeOkLoading:A,closeModal:T}]=E((function(){R(!0),z.finish=!1,z.ableList=[],z.selectedData=[],z.pagination.keyword="",z.pagination.currentPage=1,R(!1),P(),b((()=>{!function(){const e=j.value,t=e?.getScrollWrap();t?.addEventListener("scroll",(()=>{t.scrollHeight-t.clientHeight-t.scrollTop<=200&&!z.loading&&!z.finish&&(z.pagination.currentPage+=1,P())}))}()}))})),z=l({ableList:[],title:"选择用户",selectedData:[],loading:!1,pagination:{keyword:"",currentPage:1,pageSize:20},finish:!1}),{ableList:N,title:B,selectedData:M,pagination:O,loading:H}=n(z);function P(){H.value=!0,V(C.taskId,z.pagination).then((e=>{e.data.list.length<z.pagination.pageSize&&(z.finish=!0),z.ableList=[...z.ableList,...e.data.list],z.loading=!1}))}function G(){z.ableList=[],z.pagination.currentPage=1,z.finish=!1,P()}function J(){z.selectedData=[]}function $(){A(!0),w("confirm",z.selectedData),T()}return(e,t)=>{const a=s("a-input-search"),i=s("a-avatar"),l=s("jnpf-empty"),n=o("loading");return r(),c(p(K),L(e.$attrs,{onRegister:p(U),title:p(B),width:800,onOk:$,destroyOnClose:"",class:"transfer-modal"}),{default:m((()=>[d("div",Q,[d("div",q,[d("div",W,[u(a,{placeholder:p(S)("common.enterKeyword"),allowClear:"",value:p(O).keyword,"onUpdate:value":t[0]||(t[0]=e=>p(O).keyword=e),onSearch:G},null,8,["placeholder","value"])]),d("div",X,[t[1]||(t[1]=d("div",{class:"custom-title"},"全部数据",-1)),f((r(),c(p(g),{ref_key:"infiniteBody",ref:j},{default:m((()=>[(r(!0),v(y,null,k(p(N),(e=>(r(),v("div",{key:e.id,class:"selected-item selected-item-user",onClick:t=>{return a=e,void(z.selectedData.some((e=>e.id===a.id))||z.selectedData.push(a));var a}},[d("div",Z,[u(i,{size:36,src:D.value+e.headIcon,class:"selected-item-headIcon"},null,8,["src"]),d("div",ee,[d("p",te,_(e.fullName),1),d("p",{class:"organize",title:e.organize},_(e.organize),9,ae)])])],8,Y)))),128)),p(N).length?h("",!0):(r(),c(l,{key:0}))])),_:1})),[[n,p(H)&&1===p(O).currentPage]])])]),d("div",ie,[d("div",le,[d("span",null,_(p(S)("component.jnpf.common.selected")),1),d("span",{class:"remove-all-btn",onClick:J},"清空列表")]),d("div",ne,[u(p(g),null,{default:m((()=>[(r(!0),v(y,null,k(p(M),((e,t)=>(r(),v("div",{key:t,class:"selected-item selected-item-user"},[d("div",se,[u(i,{size:36,src:D.value+e.headIcon,class:"selected-item-headIcon"},null,8,["src"]),d("div",oe,[d("p",re,_(e.fullName),1),d("p",{class:"organize",title:e.organize},_(e.organize),9,ce)]),u(p(I),{class:"delete-btn",onClick:e=>{return a=t,void z.selectedData.splice(a,1);var a}},null,8,["onClick"])])])))),128)),p(M).length?h("",!0):(r(),c(l,{key:0}))])),_:1})])])])])),_:1},16,["onRegister","title"])}}}),de={key:1},ue={key:0,class:"comment-img-list"},pe=["src","onClick"],fe=["onClick"],ge={class:"comment-input-wrapper-actions"},ve={class:"actions-left"},ye={class:"emojiBox"},ke={class:"emoji"},_e=["onClick"],he=["src"],Ie=e({__name:"CommentInput",props:{inner:{type:Boolean,default:!1},taskId:{type:[String,Number],default:""},replyId:{type:String,default:""}},emits:["hideCommentInput","reload"],setup(e,{emit:t}){const o=e,c=t,f=l({commentActive:!1,imgList:[],emojiList:G,popoverVisible:!1,imgUploading:!1,dataForm:{text:"",file:[],image:[]},selectionStart:0,selectForm:"",btnLoading:!1}),{commentActive:g,dataForm:_,btnLoading:I}=n(f),[L,{openModal:R}]=P(),{createMessage:A}=U(),T=a(),z=i(T.apiUrl),N=i(null),B=i(null),O=x((()=>T.uploadUrl+"/annexpic")),H=x((()=>({Authorization:C()}))),E=x((()=>["comment-input-wrapper",{"comment-input-wrapper-inner":o.inner,"comment-input-wrapper-active":f.commentActive}])),K=x((()=>!f.dataForm.text));function V(){f.commentActive=!0,b((()=>{B.value?.focus()}))}function J(){f.commentActive=!1,$(),o.inner&&c("hideCommentInput")}function $(){f.btnLoading=!1,f.dataForm.text="",f.imgList=[],f.dataForm.image=[],f.dataForm.file=[]}function Q(){f.btnLoading=!0;let e={text:f.dataForm.text,file:JSON.stringify(f.dataForm.file),image:JSON.stringify(f.dataForm.image),taskId:o.taskId,replyId:o.replyId};M(e).then((()=>{f.btnLoading=!1,$(),c("reload")})).catch((()=>{f.btnLoading=!1}))}function q(e){"@"===e.data&&(f.selectForm="input",f.selectionStart=e.target.selectionStart,R(!0,{}))}function W(e){if(!e||!e.length)return;let t="btn"===f.selectForm?"@":"";for(let a=0;a<e.length;a++){t+=(a>0?"@":"")+`{${e[a].fullName}}`}if(-1===f.selectionStart)f.dataForm.text+=t,B.value.focus();else{let e=f.dataForm.text,a=f.selectionStart+t.length;f.dataForm.text=e.slice(0,f.selectionStart)+t+e.slice(f.selectionStart),setTimeout((()=>{B.value.focus(),B.value?.resizableTextArea?.textArea?.setSelectionRange(a,a)}),50)}}function X(e){if(f.dataForm.image.length>=9)return A.error("最多可以上传9张图片"),S.LIST_IGNORE;const t=e.size<10485760;if(!t)return A.error("图片大小超过10MB"),S.LIST_IGNORE;let a=new RegExp("image/*").test(e.type);return a?t&&a:(A.error("请上传图片"),S.LIST_IGNORE)}function Y({file:e}){if("uploading"===e.status)return f.imgUploading=!0;if("error"===e.status)return f.imgUploading=!1,f.imgList=f.imgList.filter((t=>t.uid!=e.uid)),void A.error("上传失败");if("done"===e.status)if(f.imgUploading=!1,200===e.response.code){if(f.dataForm.image.length>=9)return A.error("最多可以上传9张图片"),!1;f.dataForm.image.push({name:e.name,fileId:e.response.data.name,url:e.response.data.url})}else f.imgList=f.imgList.filter((t=>t.uid!=e.uid)),A.error(e.response.msg)}function Z(){if(f.dataForm.file.length>=9)return A.error("最多可以上传9个文件");N.value?.uploadFile()}return(t,a)=>{const i=s("a-textarea"),l=s("jnpf-upload-file"),n=s("a-tooltip"),o=s("a-popover"),c=s("a-button");return r(),v("div",{class:D(E.value)},[p(g)?h("",!0):(r(),v("div",{key:0,class:"comment-input-placeholder",onClick:V},"请输入")),p(g)?(r(),v("div",de,[u(i,{value:p(_).text,"onUpdate:value":a[0]||(a[0]=e=>p(_).text=e),class:"comment-input-wrapper-content",placeholder:"请输入",autoSize:{minRows:4,maxRows:4},maxlength:500,showCount:"",ref_key:"textRef",ref:B,onInput:q},null,8,["value"]),p(_).image.length?(r(),v("div",ue,[(r(!0),v(y,null,k(p(_).image,((e,t)=>(r(),v("div",{class:"img-item",key:t},[d("img",{src:z.value+e.url,class:"img-item",onClick:e=>function(e){const t=f.dataForm.image.map((e=>z.value+e.url));j({imageList:t,index:e})}(t)},null,8,pe),d("div",{class:"badge",onClick:w((e=>{return a=t,f.dataForm.image.splice(a,1),void f.imgList.splice(a,1);var a}),["stop"])},a[5]||(a[5]=[d("i",{class:"icon-ym icon-ym-nav-close"},null,-1)]),8,fe)])))),128))])):h("",!0),u(l,{ref_key:"uploadFileRef",ref:N,value:p(_).file,"onUpdate:value":a[1]||(a[1]=e=>p(_).file=e),limit:9,detailed:"",class:"comment-upload-file"},null,8,["value"]),d("div",ge,[d("div",ve,[u(n,{title:"选择@用户"},{default:m((()=>[d("i",{class:"icon-ym icon-ym-roll-call",onClick:a[2]||(a[2]=e=>(f.selectForm="btn",f.selectionStart=-1,void R(!0,{})))})])),_:1}),u(p(S),{"file-list":f.imgList,"onUpdate:fileList":a[3]||(a[3]=e=>f.imgList=e),accept:"image/*","show-upload-list":!1,multiple:"","max-count":9,action:O.value,headers:H.value,"before-upload":X,onChange:Y},{default:m((()=>[u(n,{title:"上传图片"},{default:m((()=>a[6]||(a[6]=[d("i",{class:"icon-ym icon-ym-comment-img"},null,-1)]))),_:1,__:[6]})])),_:1},8,["file-list","action","headers"]),u(n,{title:"上传附件"},{default:m((()=>[d("i",{class:"icon-ym icon-ym-comment-file",onClick:Z})])),_:1}),u(o,{placement:"topLeft",trigger:"click",overlayClassName:"emoji-popover",open:f.popoverVisible,"onUpdate:open":a[4]||(a[4]=e=>f.popoverVisible=e)},{content:m((()=>[d("div",ye,[d("ul",ke,[(r(!0),v(y,null,k(f.emojiList,((e,t)=>(r(),v("li",{key:t,onClick:t=>function(e){f.dataForm.text+=e.alt,f.popoverVisible=!1,B.value.focus()}(e)},[d("img",{src:"/resource/emoji/"+e.url},null,8,he)],8,_e)))),128))])])])),default:m((()=>[u(n,{title:"表情"},{default:m((()=>a[7]||(a[7]=[d("i",{class:"icon-ym icon-ym-emoji"},null,-1)]))),_:1,__:[7]})])),_:1},8,["open"])]),d("div",null,[u(c,{onClick:J,class:"mr-10px"},{default:m((()=>a[8]||(a[8]=[F("取消")]))),_:1,__:[8]}),u(c,{type:"primary",onClick:Q,disabled:K.value,loading:p(I)},{default:m((()=>a[9]||(a[9]=[F("发送")]))),_:1,__:[9]},8,["disabled","loading"])])])])):h("",!0),u(me,{taskId:e.taskId,onRegister:p(L),onConfirm:W},null,8,["taskId","onRegister"])],2)}}}),Le={class:"form-extra-comment"},be={class:"form-extra-comment-list"},xe={class:"form-extra-comment-item-main"},Ce={class:"comment-content"},we={class:"comment-head"},Se={class:"username"},Fe={key:0},De=["innerHTML"],je=["innerHTML"],Ue={key:0,class:"comment-other"},Re={key:0,class:"comment-img-list"},Ae=["src","onClick"],Te={key:1,class:"comment-file-List"},ze={class:"comment-actions"},Ne={class:"time"},Be={key:0},Me={class:"form-extra-comment-list-footer"},Oe=e({__name:"CommentList",props:{taskId:{type:[String,Number],default:""}},setup(e){const t=e,{createMessage:I}=U(),L=a(),b=i(L.apiUrl),x=i(null),C=l({list:[],loading:!1,listQuery:{currentPage:1,pageSize:1e5,sort:"desc",sidx:""}}),{list:w,loading:S}=n(C);function D(e){if(!e)return"";let t=e.replace(/\[([^(\]|\[)]*)\]/g,(t=>{let a="";for(let e=0;e<G.length;e++){let i=G[e];if(i.alt==t){a=`<img src="/resource/emoji/${i.url}" class="comment-text-emoji" />`;break}}return a||e}));return e=t}function T(){if(!t.taskId)return;C.loading=!0;const e={...C.listQuery,taskId:t.taskId};H(e).then((e=>{const t=e.data.list.map((e=>({...e,text:D(e.text),replyText:D(e.replyText),fileList:e.file?JSON.parse(e.file):[],imageList:e.image?JSON.parse(e.image):[],creatorTime:A(e.creatorTime)})));C.list=t,C.loading=!1})).catch((()=>{C.loading=!1}))}return R((()=>{T()})),(t,a)=>{const i=s("a-avatar"),l=s("a-tooltip"),n=s("jnpf-upload-file"),L=s("a-button"),D=s("a-popconfirm"),U=s("jnpf-empty"),R=o("loading");return r(),v("div",Le,[f((r(),c(p(g),{ref_key:"infiniteBody",ref:x,class:"form-extra-comment-main"},{default:m((()=>[d("div",be,[(r(!0),v(y,null,k(p(w),((t,s)=>(r(),v("div",{key:s,class:"form-extra-comment-item"},[d("div",xe,[u(i,{size:24,src:b.value+t.creatorUserHeadIcon,class:"comment-avatar"},null,8,["src"]),d("div",Ce,[d("div",we,[d("p",Se,[F(_(t.creatorUser)+" ",1),t.replyUser?(r(),v("span",Fe,[a[1]||(a[1]=d("span",{class:"replay-separate"},"回复",-1)),F(" "+_(t.replyUser)+" ",1),u(l,null,{title:m((()=>[d("div",{innerHTML:t.replyText},null,8,De)])),default:m((()=>[a[0]||(a[0]=d("i",{class:"icon-ym icon-ym-chat"},null,-1))])),_:2,__:[0]},1024)])):h("",!0)])]),d("p",{class:"comment-text",innerHTML:2==t.isDel?"该评论已被删除":t.text},null,8,je),2!=t.isDel&&(t.imageList?.length||t.fileList?.length)?(r(),v("div",Ue,[t.imageList?.length?(r(),v("div",Re,[(r(!0),v(y,null,k(t.imageList,((e,a)=>(r(),v("img",{src:b.value+e.url,class:"comment-img-item",key:a,onClick:e=>function(e,t){const a=e.map((e=>b.value+e.url));j({imageList:a,index:t})}(t.imageList,a)},null,8,Ae)))),128))])):h("",!0),t.fileList?.length?(r(),v("div",Te,[u(n,{value:t.fileList,"onUpdate:value":e=>t.fileList=e,detailed:"",disabled:""},null,8,["value","onUpdate:value"])])):h("",!0)])):h("",!0),d("div",ze,[d("span",Ne,_(t.creatorTime),1),2!=t.isDel?(r(),v("div",Be,[1==t.isDel?(r(),c(D,{key:0,title:"确定删除该评论？",onConfirm:e=>{return a=t.id,void O(a).then((e=>{I.success(e.msg),T()}));var a}},{default:m((()=>[u(L,{type:"link",color:"error"},{default:m((()=>a[2]||(a[2]=[F("删除")]))),_:1,__:[2]})])),_:2},1032,["onConfirm"])):h("",!0),u(L,{type:"link",class:"ml-10px",onClick:e=>function(e,t){e.commentActive=!0;for(let a=0;a<C.list.length;a++)a!=t&&(C.list[a].commentActive=!1)}(t,s)},{default:m((()=>a[3]||(a[3]=[F("回复")]))),_:2,__:[3]},1032,["onClick"])])):h("",!0)])])]),t.commentActive?(r(),c(Ie,{key:0,inner:"",taskId:e.taskId,replyId:t.id,onHideCommentInput:e=>t.commentActive=!1,onReload:T},null,8,["taskId","replyId","onHideCommentInput"])):h("",!0)])))),128))]),p(w).length?h("",!0):(r(),c(U,{key:0}))])),_:1})),[[R,p(S)]]),d("div",Me,[u(Ie,{taskId:e.taskId,onReload:T},null,8,["taskId"])])])}}}),He={class:"form-extra-panel-main"},Ee=e({__name:"ExtraPanel",props:{showComment:{type:Boolean,default:!1},showRecord:{type:Boolean,default:!1},showDataLog:{type:Boolean,default:!1},taskId:{type:[String,Number],default:""},modelId:{type:String,default:""},formDataId:{type:[String,Number],default:""},recordTimeList:{type:Array,default:[]},auxiliaryInfo:{type:Array,default:[]},formData:{type:Object}},setup(e){const a=e,i=l({isAdvanced:!0,activeKey:1,key:+new Date}),{isAdvanced:o,activeKey:f,key:g}=n(i),{t:y}=t(),k=x((()=>[a.showComment,a.showRecord,a.showDataLog]));function _(){i.isAdvanced=!i.isAdvanced,i.key=+new Date}return R((()=>{i.activeKey=a.showRecord?1:2})),(t,a)=>{const i=s("a-tooltip"),l=s("a-tab-pane"),n=s("a-tabs");return r(),v("div",{class:D(["form-extra-panel",{"form-extra-panel-unfold":!p(o)}])},[(r(),c(i,{placement:"left",title:p(o)?p(y)("component.form.fold"):p(y)("component.form.unfold"),key:p(g)},{default:m((()=>[d("div",{class:"trigger-btn",onClick:_},[p(o)?(r(),c(p(T),{key:0})):(r(),c(p(z),{key:1}))])])),_:1},8,["title"])),u(n,{activeKey:p(f),"onUpdate:activeKey":a[0]||(a[0]=e=>N(f)?f.value=e:null),tabBarGutter:10,size:"small",class:D(["average-tabs flow-average-tabs",{"average-tabs-single":1===k.value.filter(Boolean).length}])},{default:m((()=>[e.showRecord?(r(),c(l,{key:1,tab:"流转"})):h("",!0),e.showComment?(r(),c(l,{key:2,tab:"评论"})):h("",!0),e.showDataLog?(r(),c(l,{key:3,tab:"修改记录"})):h("",!0),e.auxiliaryInfo.length?(r(),c(l,{key:4,tab:"辅助信息"})):h("",!0)])),_:1},8,["activeKey","class"]),d("div",He,[1==p(f)?(r(),c(B,{key:0,taskId:e.taskId,list:e.recordTimeList},null,8,["taskId","list"])):h("",!0),2==p(f)?(r(),c(Oe,{key:1,taskId:e.taskId},null,8,["taskId"])):h("",!0),3==p(f)?(r(),c(J,{key:2,modelId:e.modelId,formDataId:e.formDataId},null,8,["modelId","formDataId"])):h("",!0),4==p(f)?(r(),c($,{key:3,list:e.auxiliaryInfo,formData:e.formData},null,8,["list","formData"])):h("",!0)])],2)}}});export{Ee as _};
