import{d as e,ad as t,a6 as n,aw as i,M as a,n as s,dk as o,co as r,k as p,o as l,g as f,j as d,bf as m,i as c,v as u,a4 as h,q as w,ah as g}from"./index-920db443.js";import{$ as T,a as y}from"./jquery-6353a699.js";import{u as D}from"./document-763aa4ad.js";import{u as I}from"./useDefineSetting-7df030ff.js";const v={key:0,class:"flow-file"},Y={id:"previewDesignedWrap"},L=e({__name:"FlowFile",emits:["fileEnd"],setup(e,{expose:L,emit:F}){L({init:function(e){if(H.id=e.id||"",H.formInfo=e.formInfo||[],H.opType=e.opType,!H.id||!H.formInfo.length)return U();H.showFileLoading=!0,s((()=>async function(){T("#previewDesignedWrap").html(null);const{data:e}=await y({id:H.id,formInfo:H.formInfo})||{};if(!e)return U();!function(){const e=p(R).userName+"/"+p(R).userAccount,t=r((new Date).getTime()).format("YYYY-MM-DD HH:mm:ss");H.systemInfo.printer=e,H.systemInfo.printTime=t}();const t=e?.map(((e,t)=>{let{printData:n,printTemplate:i,operatorRecordList:a=[],convertConfig:s=""}=e||{};try{const e=JSON.parse(i);return 0===t&&(H.hiprintTemplate=new o.hiprint.PrintTemplate({template:e})),s&&(n=function(e,t){const n=JSON.parse(t);for(let i=0;i<n.length;i++){const t=n[i];if("singleImg"!==t.type)continue;const a=t.field.split(".")[0],s=t.field.split(".")[1];if(Reflect.has(e,a))for(let n=0;n<e[a].length;n++)Reflect.has(e[a][n],s)&&e[a][n][s]&&(e[a][n][s]=k.apiUrl+e[a][n][s])}return e}(n,s)),n.operatorRecordList=a.map((e=>({...e,handleTime:r(e.handleTime).format("YYYY-MM-DD HH:mm:ss"),handleStatus:S(e.handleStatus)}))),n.systemInfo=H.systemInfo,n}catch(p){return T("#previewDesignedWrap").append('<div class="print-single-wrap"><div class="tpl-invalid">模板已失效，请重新设计</div></div>'),null}}));if(!H.hiprintTemplate)return U();H.dataList=[...t],function(){if(!window.hinnn)return;window.hinnn.apiUrl=k.apiUrl,window.hinnn.dateFormat=function(e,t){return e?(isNaN(e)||"string"!=typeof e||(e=Number(e)),t=t.replaceAll("y","Y").replaceAll("d","D"),r(e).format(t)):""}}();const n=H.hiprintTemplate?.getHtml(H.dataList);T("#previewDesignedWrap").html(n),function(){if(!H.hiprintTemplate||!H.dataList?.length)return U();H.hiprintTemplate?.toPdf(H.dataList,`${H.id}_${r().format("YYYYMMDDHHmmss")}`,{isDownload:!1}).then((e=>{const t=new FormData;t.append("file",e),t.append("taskId",H.formInfo[0].flowTaskId),D(t).then((()=>{window.close(),U("归档成功！")})).catch((()=>{U()}))})).catch((()=>{U()}))}()}()))}});const M=F,H=t({id:"",opType:"",hiprintTemplate:void 0,dataList:[],systemInfo:{printer:"",printTime:""},showFileLoading:!1,formInfo:[]}),j=n(),{createMessage:N}=g(),{getFlowStateContent:S}=I(),k=i(),R=a((()=>j.getUserInfo||{}));function U(e){if(H.showFileLoading=!1,e)return M("fileEnd"),void N.success(e);M("fileEnd"),N.error("6"!=H.opType?"归档失败，请联系管理员在流程监控中手动归档！":"归档失败！")}return(e,t)=>H.showFileLoading?(l(),f("div",v,[d(p(m),{tip:"正在归档..."}),c(h("div",Y,null,512),[[u,!1]])])):w("",!0)}});export{L as _};
