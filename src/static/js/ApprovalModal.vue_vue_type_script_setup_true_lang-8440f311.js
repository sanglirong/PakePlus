import{b as e,B as a}from"./index-143f5813.js";import{U as t}from"./index-c37d2476.js";import{d as l,a6 as d,r as i,ad as n,a0 as r,M as o,e as s,o as u,p,l as c,j as m,k as g,g as v,F as f,m as b,a4 as y,h,t as _,q as k,V as C,aP as L,n as S}from"./index-920db443.js";import{_ as T}from"./OpinionTextarea.vue_vue_type_style_index_0_lang-cb910758.js";import{o as I}from"./task-ee77df5a.js";const U={class:"flex items-center"},N=l({__name:"ApprovalModal",emits:["register","confirm"],setup(l,{emit:N}){const j=N,F=d(),x=i(),P=n({dataForm:{copyIds:[],branchList:[],candidateList:[],fileList:[],handleOpinion:"",signImg:"",backType:1,backNodeCode:"",addSignParameter:{addSignUserIdList:[],addSignType:1,counterSign:0,auditRatio:100}},defaultCandidateList:[],branchList:[],operatorId:"",formData:{},eventType:"",properties:{},backNodeCodeList:[],title:"",label:""}),{dataForm:A,properties:w,eventType:q,label:O,branchList:R}=r(P),[B,{changeOkLoading:D}]=e((function(e){D(!1),P.dataForm={copyIds:[],branchList:[],candidateList:[],fileList:[],handleOpinion:"",signImg:"",backType:1,backNodeCode:"",addSignParameter:{addSignUserIdList:[],addSignType:1,counterSign:0,auditRatio:100}},P.operatorId=e.operatorId||"",P.formData=e.formData,P.eventType=e.eventType,P.title=function(){const e=P.eventType;return"reject"==e?"审批拒绝":"back"==e?"审批退回":"freeApprover"==e?"加签":"审批同意"}(),P.label="freeApprover"===P.eventType?"加签":"back"===P.eventType?"退回":"审批",P.properties=e.properties,P.backNodeCodeList=e.backNodeCodeList.map((e=>({id:e.nodeCode,fullName:e.nodeName}))),P.properties.hasSign&&(P.dataForm.signImg=g($).signImg);P.dataForm.backNodeCode=e.backNodeCodeList.length?e.backNodeCodeList[0].nodeCode:"",P.branchList=e.branchList.map((e=>({...L(e,["nodeCode","nodeName"]),id:e.nodeCode,fullName:e.nodeName}))),P.defaultCandidateList=e.candidateList.map((e=>({...e,label:"审批人",value:[],rules:e.selected?[]:[{required:!0,message:"必填",trigger:"change",type:"array"}]}))),P.dataForm.candidateList=P.defaultCandidateList,S((()=>{x.value?.clearValidate()}))})),$=o((()=>F.getUserInfo||{}));async function H(){try{if(!(await(x.value?.validate())))return;let e={};if(P.dataForm.candidateList.length)for(let t=0;t<P.dataForm.candidateList.length;t++)e[P.dataForm.candidateList[t].nodeCode]=P.dataForm.candidateList[t].value;D(!0);const a={...P.dataForm,candidateList:e,copyIds:P.dataForm.copyIds.join(",")};3!=P.properties.backType&&(a.backType=P.properties.backType),"freeApprover"!==P.eventType&&delete a.addSignParameter,j("confirm",a)}catch(e){}}function M(e){if(!e.length)return P.dataForm.candidateList=P.defaultCandidateList;let a=[];for(let t=0;t<e.length;t++)e:for(let l=0;l<P.branchList.length;l++){let d=P.branchList[l];if(e[t]===d.id&&d.isCandidates){a.push({nodeCode:d.id,nodeName:d.fullName,isCandidates:d.isCandidates,hasCandidates:d.hasCandidates,label:"审批人",value:[],rules:d.selected?[]:[{required:!0,message:"必填",trigger:"change",type:"array"}]});break e}}P.dataForm.candidateList=[...P.defaultCandidateList,...a]}return(e,l)=>{const d=s("jnpf-user-select"),i=s("a-form-item"),n=s("a-radio-button"),r=s("a-radio-group"),o=s("a-radio"),L=s("a-select-option"),S=s("a-select"),N=s("jnpf-select"),j=s("jnpf-textarea"),F=s("BasicHelp"),D=s("jnpf-sign"),$=s("jnpf-upload-file"),V=s("a-form");return u(),p(g(a),C(e.$attrs,{onRegister:g(B),title:P.title,onOk:H,minHeight:52}),{default:c((()=>[m(V,{colon:!1,labelCol:{style:{width:g(A).candidateList?.length||g(R).length?"130px":"80px"}},model:g(A),ref_key:"formElRef",ref:x},{default:c((()=>["freeApprover"===g(q)?(u(),v(f,{key:0},[m(i,{label:"加签人员",name:["addSignParameter","addSignUserIdList"],rules:[{required:!0,message:"必填",trigger:"change"}]},{default:c((()=>[m(d,{value:g(A).addSignParameter.addSignUserIdList,"onUpdate:value":l[0]||(l[0]=e=>g(A).addSignParameter.addSignUserIdList=e),multiple:"",allowClear:""},null,8,["value"])])),_:1}),m(i,{label:"加签类型",name:"addSignType"},{default:c((()=>[m(r,{value:g(A).addSignParameter.addSignType,"onUpdate:value":l[1]||(l[1]=e=>g(A).addSignParameter.addSignType=e),"button-style":"solid"},{default:c((()=>[m(n,{value:1},{default:c((()=>l[12]||(l[12]=[b("审批前")]))),_:1,__:[12]}),m(n,{value:2},{default:c((()=>l[13]||(l[13]=[b("审批后")]))),_:1,__:[13]})])),_:1},8,["value"])])),_:1}),m(i,{label:"审批方式",name:"counterSign"},{default:c((()=>[m(r,{value:g(A).addSignParameter.counterSign,"onUpdate:value":l[2]||(l[2]=e=>g(A).addSignParameter.counterSign=e)},{default:c((()=>[m(o,{value:0},{default:c((()=>l[14]||(l[14]=[b("或签")]))),_:1,__:[14]}),m(o,{value:1},{default:c((()=>l[15]||(l[15]=[b("会签")]))),_:1,__:[15]}),m(o,{value:2},{default:c((()=>l[16]||(l[16]=[b("依次审批")]))),_:1,__:[16]})])),_:1},8,["value"])])),_:1}),1===g(A).addSignParameter.counterSign?(u(),p(i,{key:0,label:"会签比例",name:"auditRatio"},{default:c((()=>[y("div",U,[m(S,{value:g(A).addSignParameter.auditRatio,"onUpdate:value":l[3]||(l[3]=e=>g(A).addSignParameter.auditRatio=e),class:"flex-1 !mr-10px"},{default:c((()=>[(u(),v(f,null,h(10,(e=>m(L,{key:e,value:10*e},{default:c((()=>[b(_(10*e+"%"),1)])),_:2},1032,["value"]))),64))])),_:1},8,["value"]),l[17]||(l[17]=b(" 达到会签比例则通过 "))])])),_:1})):k("",!0)],64)):k("",!0),"audit"===g(q)||"reject"===g(q)||"freeApprover"===g(q)&&2===g(A).addSignParameter.addSignType?(u(),v(f,{key:1},[g(R).length?(u(),p(i,{key:0,label:"分支选择",name:"branchList",rules:[{required:!0,message:"必填",trigger:"change",type:"array"}]},{default:c((()=>[m(N,{value:g(A).branchList,"onUpdate:value":l[4]||(l[4]=e=>g(A).branchList=e),multiple:"",placeholder:"请选择",allowClear:"",onChange:M,options:g(R),showSearch:""},null,8,["value","options"])])),_:1})):k("",!0),(u(!0),v(f,null,h(g(A).candidateList,((e,a)=>(u(),v(f,{key:a},[m(i,{label:e.nodeName+e.label,name:["candidateList",a,"value"],rules:e.rules},{default:c((()=>[e.hasCandidates?(u(),p(g(t),{key:0,value:e.value,"onUpdate:value":a=>e.value=a,multiple:"",placeholder:"请选择"+e.label,query:{...P.formData,nodeCode:e.nodeCode,operatorId:P.operatorId},api:g(I),modalTitle:"候选人员"},null,8,["value","onUpdate:value","placeholder","query","api"])):(u(),p(d,{key:1,value:e.value,"onUpdate:value":a=>e.value=a,multiple:"",placeholder:"请选择"+e.label,modalTitle:"候选人员"},null,8,["value","onUpdate:value","placeholder"]))])),_:2},1032,["label","name","rules"]),e.selected?(u(),p(i,{key:0,label:"已选审批人",class:"candidate-selected"},{default:c((()=>[m(j,{value:e.selected,"onUpdate:value":a=>e.selected=a,autoSize:{minRows:1,maxRows:4},disabled:""},null,8,["value","onUpdate:value"])])),_:2},1024)):k("",!0)],64)))),128))],64)):k("",!0),"back"===g(q)&&g(w).backType?(u(),v(f,{key:2},[m(i,{label:"退回节点",name:"backNodeCode",rules:[{required:!0,message:"必填",trigger:"change"}]},{default:c((()=>[m(N,{value:g(A).backNodeCode,"onUpdate:value":l[5]||(l[5]=e=>g(A).backNodeCode=e),options:P.backNodeCodeList,disabled:2!==g(w).backNodeCode,showSearch:""},null,8,["value","options","disabled"])])),_:1}),3==g(w).backType?(u(),p(i,{key:0,label:" ",name:"backType"},{default:c((()=>[m(r,{value:g(A).backType,"onUpdate:value":l[6]||(l[6]=e=>g(A).backType=e)},{default:c((()=>[m(o,{value:1},{default:c((()=>[l[18]||(l[18]=b("重新审批")),m(F,{text:"若流程为A->B->C，C退回至A，则C->A->B->C"})])),_:1,__:[18]}),m(o,{value:2},{default:c((()=>[l[19]||(l[19]=b("直接提交给我")),m(F,{text:"若流程为A->B->C，C退回至A，则C->A->C"})])),_:1,__:[19]})])),_:1},8,["value"])])),_:1})):k("",!0)],64)):k("",!0),["audit","reject"].includes(g(q))&&g(w).isCustomCopy?(u(),p(i,{key:3,label:"抄送人员",name:"copyIds"},{default:c((()=>[m(d,{value:g(A).copyIds,"onUpdate:value":l[7]||(l[7]=e=>g(A).copyIds=e),multiple:"",allowClear:""},null,8,["value"])])),_:1})):k("",!0),m(i,{label:`${g(O)}意见`,name:"handleOpinion",rules:["audit","reject"].includes(g(q))?[{required:!0,message:"必填",trigger:"change"}]:[]},{default:c((()=>[["audit","reject"].includes(g(q))?(u(),p(T,{key:0,value:g(A).handleOpinion,"onUpdate:value":l[8]||(l[8]=e=>g(A).handleOpinion=e),commonWordsCount:2},null,8,["value"])):(u(),p(j,{key:1,value:g(A).handleOpinion,"onUpdate:value":l[9]||(l[9]=e=>g(A).handleOpinion=e),placeholder:"请输入"},null,8,["value"]))])),_:1},8,["label","rules"]),g(w).hasSign?(u(),p(i,{key:4,label:`${g(O)}签名`,name:"signImg",rules:["audit","reject"].includes(g(q))?[{required:!0,message:"请签名",trigger:"change"}]:[]},{default:c((()=>[m(D,{value:g(A).signImg,"onUpdate:value":l[10]||(l[10]=e=>g(A).signImg=e),isInvoke:""},null,8,["value"])])),_:1},8,["label","rules"])):k("",!0),g(w).hasFile?(u(),p(i,{key:5,label:`${g(O)}附件`,name:"fileList"},{default:c((()=>[m($,{value:g(A).fileList,"onUpdate:value":l[11]||(l[11]=e=>g(A).fileList=e),type:"workFlow",limit:3},null,8,["value"])])),_:1},8,["label"])):k("",!0)])),_:1},8,["labelCol","model"])])),_:1},16,["onRegister","title"])}}});export{N as _};
