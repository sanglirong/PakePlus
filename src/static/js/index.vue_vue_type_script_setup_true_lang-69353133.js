import{d as e,ad as t,o as n,p as o,l as a,g as i,h as r,F as l,V as s,k as f,t as d,a5 as c,a0 as p,a6 as m,aw as u,M as _,e as g,a4 as y,dj as h,j as C,m as v,u as x,dk as I,co as D,dl as w,cd as k,r as b,c as T,n as L,a9 as F,q as j,am as M,ae as R,i as O,aS as P,ah as S,cn as B,cm as V,dm as K,dn as A,ci as N}from"./index-920db443.js";import{g as Y,a as E,c as U,l as H,d as J}from"./visualDev-8f54ab4b.js";import{u as W,B as $}from"./index-9c138ba5.js";import{b as q,B as z,u as G}from"./index-143f5813.js";import{u as Q,B as X}from"./index-999abbee.js";import{_ as Z}from"./Parser.vue_vue_type_script_setup_true_lang-6ddfe448.js";import{_ as ee,a as te}from"./Form.vue_vue_type_script_setup_true_lang-63005a4d.js";import{g as ne,$ as oe,a as ae}from"./jquery-6353a699.js";import{u as ie}from"./useDefineSetting-7df030ff.js";import{_ as re}from"./CustomForm.vue_vue_type_script_setup_true_lang-1aa664f4.js";import{c as le}from"./createAsyncComponent-7e8f72ac.js";const se=["onClick"],fe=c(e({__name:"index",emits:["register","change"],setup(e,{emit:c}){const p=t({printListOptions:[]}),m=c,[u,{closeModal:_,changeLoading:g}]=q((function(e){g(!0),ne({ids:e}).then((e=>{p.printListOptions=e.data,g(!1)}))}));return(e,t)=>(n(),o(f(z),s(e.$attrs,{onRegister:f(u),title:"请选择打印模板",footer:null,width:"400px",minHeight:250,class:"template-list"}),{default:a((()=>[(n(!0),i(l,null,r(p.printListOptions,(e=>(n(),i("div",{class:"template-item",key:e.id,onClick:t=>function(e,t){m("change",t.id),_()}(0,e)},d(e.fullName),9,se)))),128))])),_:1},16,["onRegister"]))}}),[["__scopeId","data-v-609072c6"]]),de={class:"jnpf-full-modal-header"},ce=e({__name:"index",setup(e){const i=t({fullName:void 0,hiprintTemplate:void 0,dataList:[],loading:!1,systemInfo:{printer:"",printTime:""}}),{loading:r}=p(i),{t:l}=x(),c=m(),[w,{closeModal:k,changeLoading:b}]=q((async function(e){const{id:t,formInfo:n=[]}=e||{};if(!t||!n.length)return;oe("#previewDesignedWrap").html(null),b(!0),i.loading=!0;const{data:o}=await ae({id:t,formInfo:n})||{};if(i.loading=!1,b(!1),!o)return;!function(){const e=f(F).userName+"/"+f(F).userAccount,t=D((new Date).getTime()).format("YYYY-MM-DD HH:mm:ss");i.systemInfo.printer=e,i.systemInfo.printTime=t}();const a=o?.map(((e,t)=>{let{printData:n,printTemplate:o,operatorRecordList:a=[],convertConfig:r=""}=e||{};try{const l=JSON.parse(o);return 0===t&&(i.hiprintTemplate=new I.hiprint.PrintTemplate({template:l}),i.fullName=e.fullName||""),r&&(n=function(e,t){const n=JSON.parse(t);for(let o=0;o<n.length;o++){const t=n[o];if("singleImg"!==t.type)continue;const a=t.field.split(".")[0],i=t.field.split(".")[1];if(Reflect.has(e,a))for(let n=0;n<e[a].length;n++)Reflect.has(e[a][n],i)&&e[a][n][i]&&(e[a][n][i]=L.apiUrl+e[a][n][i])}return e}(n,r)),n.operatorRecordList=a.map((e=>({...e,handleTime:D(e.handleTime).format("YYYY-MM-DD HH:mm:ss"),handleStatus:T(e.handleStatus)}))),n.systemInfo=i.systemInfo,n}catch(l){return oe("#previewDesignedWrap").append('<div class="print-single-wrap"><div class="tpl-invalid">模板已失效，请重新设计</div></div>'),null}}));if(!i.hiprintTemplate)return;i.dataList=[...a],function(){if(!window.hinnn)return;window.hinnn.apiUrl=L.apiUrl,window.hinnn.dateFormat=function(e,t){return e?(isNaN(e)||"string"!=typeof e||(e=Number(e)),t=t.replaceAll("y","Y").replaceAll("d","D"),D(e).format(t)):""}}();const r=i.hiprintTemplate?.getHtml(i.dataList);oe("#previewDesignedWrap").html(r)})),{getFlowStateContent:T}=ie(),L=u(),F=_((()=>c.getUserInfo||{}));function j(){i.hiprintTemplate&&i.dataList?.length&&i.hiprintTemplate?.toPdf(i.dataList,`${i.fullName}_${D().format("YYYYMMDDHHmmss")}`,{isDownload:!0}).then((()=>{}))}function M(){if(!i.hiprintTemplate||!i.dataList?.length)return;i.loading=!0;i.hiprintTemplate?.print(i.dataList,{leftOffset:0,topOffset:0},{callback:()=>{i.loading=!1},styleHandler:()=>'<link rel="stylesheet" href="/css/print-lock.css" />'})}return(e,t)=>{const i=g("a-button"),c=g("a-space");return n(),o(f(z),s(e.$attrs,{onRegister:f(w),defaultFullscreen:"",footer:null,closable:!1,keyboard:!1,destroyOnClose:"",class:"jnpf-full-modal full-modal jnpf-print-preview-modal"}),{title:a((()=>[y("div",de,[t[2]||(t[2]=y("div",{class:"header-title"},[y("img",{src:h,class:"header-logo"}),y("span",{class:"header-dot"}),y("p",{class:"header-txt"},"打印预览")],-1)),C(c,{class:"options",size:10},{default:a((()=>[C(i,{type:"primary",onClick:j,disabled:f(r)},{default:a((()=>t[1]||(t[1]=[v("导出PDF")]))),_:1,__:[1]},8,["disabled"]),C(i,{type:"primary",onClick:M,disabled:f(r)},{default:a((()=>[v(d(f(l)("common.printText")),1)])),_:1},8,["disabled"]),C(i,{onClick:t[0]||(t[0]=e=>f(k)())},{default:a((()=>[v(d(f(l)("common.cancelText")),1)])),_:1})])),_:1})])])),default:a((()=>[t[3]||(t[3]=y("div",{id:"previewDesignedWrap"},null,-1))])),_:1,__:[3]},16,["onRegister"])}}}),pe={class:"jnpf-common-form-wrapper"},me={class:"jnpf-content-detail-extra"},ue={key:1,class:"h-full"},_e={class:"p-10px"},ge=e({name:"Detail",__name:"index",emits:["close"],setup(e,{expose:c,emit:u}){const h=le((()=>w((()=>import("./ExtraList-82620479.js")),["static/js/ExtraList-82620479.js","static/js/visualDev-8f54ab4b.js","static/js/index-920db443.js","static/css/index-648461a4.css","static/js/useForm-1d28ee0b.js","static/js/componentMap-c91676b4.js","static/js/config-06ca91cd.js","static/js/upperFirst-2cd1a2f7.js","static/js/index-999abbee.js","static/js/ArrowLeftOutlined-3fbf15bc.js","static/js/log-2a5f2c26.js","static/css/index-cddfced7.css","static/css/componentMap-489cc2b1.css","static/js/useTabs-ceeccdba.js","static/js/uniqBy-e868edd7.js","static/js/index-143f5813.js","static/js/useWindowSizeFn-05f906e2.js","static/css/index-e7d3e030.css","static/css/useForm-9fc932de.css","static/js/useTable-dc8c9d84.js","static/js/sortable.esm-02d0fe44.js","static/js/SettingOutlined-dd6150a2.js","static/js/index-1cfe4e28.js","static/css/useTable-ff181666.css","static/js/TableAction-adbe36f2.js","static/js/Form.vue_vue_type_script_setup_true_lang-63005a4d.js","static/js/createAsyncComponent-7e8f72ac.js","static/js/index-9c138ba5.js","static/css/index-01bda6b6.css","static/js/DataLogList.vue_vue_type_script_setup_true_lang-c225eb8c.js","static/js/index-0be8277c.js","static/css/DataLogList-12ff8c0e.css","static/js/ChildTableColumn.vue_vue_type_script_setup_true_lang-1a28ca33.js","static/js/Parser.vue_vue_type_script_setup_true_lang-6ddfe448.js","static/js/Item.vue_vue_type_script_setup_true_lang-fef56f78.js","static/js/jquery-6353a699.js","static/js/useDefineSetting-7df030ff.js","static/js/CustomForm.vue_vue_type_script_setup_true_lang-1aa664f4.js"]))),I=u,D=m(),q=k(),{createMessage:ne,createConfirm:oe}=S(),{t:ae}=x(),[ie,{openPopup:se,closePopup:de,setPopupProps:ge}]=W(),[ye,{openModal:he,closeModal:Ce,setModalProps:ve}]=G(),[xe,{openDrawer:Ie,closeDrawer:De,setDrawerProps:we}]=Q(),[ke,{openModal:be}]=G(),[Te,{openModal:Le}]=G(),Fe=b(null),je=b(null),Me=b(null),Re=b(null),Oe=b(null),Pe=t({formConf:{},formData:{},config:{},loading:!1,key:+new Date,dataForm:{id:"",data:""},formOperates:[],title:ae("common.detailText"),detailVisible:!1,formVisible:!1,customBtns:[],extraList:[],extraActiveKey:0,extraConfig:{},extraLoading:!1,extraKey:0,hideExtra:!1}),{title:Se,formConf:Be,formData:Ve,key:Ke,loading:Ae,detailVisible:Ne,formVisible:Ye,extraList:Ee,extraActiveKey:Ue,extraLoading:He,extraKey:Je,hideExtra:We}=p(Pe),$e=_((()=>(Pe.formConf.printButtonTextI18nCode?ae(Pe.formConf.printButtonTextI18nCode,Pe.formConf.printButtonText):Pe.formConf.printButtonText)||ae("common.printText"))),qe=_((()=>({showLog:Pe.formConf.dataLog,modelId:Pe.config.modelId,formDataId:Pe.config.id})));function ze(){if(et(!0),Pe.loading=!0,Pe.config.id){const e={modelId:Pe.config.modelId,id:Pe.config.id,type:2};q.setDynamicModelExtra(e),function(e,t){let n={id:e,menuId:Pe.config.menuId};t&&(n={...n,propsValue:t});Y(Pe.config.modelId,n).then((e=>{Pe.dataForm=e.data||{},Pe.dataForm.data&&(Pe.formData=JSON.parse(Pe.dataForm.data),function(e,t){const n=(e,o)=>{for(let a=0;a<e.length;a++){let i=e[a];if(i.__vModel__){if("relationForm"===i.__config__.jnpfKey||"popupSelect"===i.__config__.jnpfKey)i.__config__.defaultValue=t[i.__vModel__+"_id"],i.name=t[i.__vModel__]||"";else{const e=t.hasOwnProperty(i.__vModel__)?t[i.__vModel__]:i.__config__.defaultValue;i.__config__.defaultValue=e}if(!Pe.config.isDataManage&&Pe.config.useFormPermission){let e=i.__config__.isSubTable?o.__vModel__+"-"+i.__vModel__:i.__vModel__,t=!0;Pe.formOperates&&Pe.formOperates.length&&(t=!Pe.formOperates.some((t=>t.enCode===e))),t=i.__config__.noShow?i.__config__.noShow:t,i.__config__.noShow=t}}else["relationFormAttr","popupAttr"].includes(i.__config__.jnpfKey)&&(i.__config__.defaultValue=t[i.relationField.split("_jnpfTable_")[0]+"_"+i.showField]);i.__config__&&i.__config__.children&&Array.isArray(i.__config__.children)&&n(i.__config__.children,i)}};n(e.fields)}(Pe.formConf,Pe.formData),Ge(Pe.formConf.fields),L((()=>{Pe.loading=!1,Pe.key=+new Date,et(!1)})))}))}(Pe.config.id,Pe.config.propsValue)}else!function(){if("fullScreen"===Pe.formConf.popupType)return de();if("drawer"===Pe.formConf.popupType)return De();Ce()}()}function Ge(e){e.forEach((t=>{const n=t.__config__;if("relationFormAttr"==n.jnpfKey||"popupAttr"==n.jnpfKey){const n=t.relationField.split("_jnpfTable_")[0];e.forEach((e=>{const o=Array.isArray(e.__config__.visibility)&&!e.__config__.visibility.includes("pc");n!=e.__vModel__||!o&&!e.__config__.noShow||t.__vModel__||(t.__config__.noShow=!0)}))}t.__config__.children&&t.__config__.children.length&&Ge(t.__config__.children)}))}function Qe(e){e.__config__.defaultValue&&E(e.modelId).then((t=>{if(!t.data)return;if(!t.data.formData)return;const n=JSON.parse(t.data.formData);n.popupType=Pe.formData.popupType,n.customBtns=[],n.hasPrintBtn=!1;const o={id:e.__config__.defaultValue,formConf:n,modelId:e.modelId,propsValue:e.propsValue};Pe.detailVisible=!0,L((()=>{je.value?.init(o)}))}))}function Xe(){return Pe.config.isPreview?ne.warning("功能预览不支持打印"):Pe.formConf.printId?.length?1===Pe.formConf.printId?.length?Ze(Pe.formConf.printId[0]):void be(!0,Pe.formConf.printId):ne.error("未配置打印模板")}function Ze(e){Le(!0,{id:e,formInfo:[{formId:Pe.dataForm.id}]})}function et(e){var t;t={loading:e},"fullScreen"===Pe.formConf.popupType?ge(t):"drawer"===Pe.formConf.popupType?we(t):ve(t)}async function tt(){return I("close"),!0}function nt(e){1==e.actionConfig.btnType&&function(e){const t={...e,recordModelId:Pe.config.modelId,record:Pe.formData};Me.value?.init(t)}(e.actionConfig),2==e.actionConfig.btnType&&function(e){const t={data:Pe.formData,onlineUtils:B},n=V(e.func);if(!n)return;n(t)}(e.actionConfig),3==e.actionConfig.btnType&&function(e){const t=()=>{J(Pe.config.modelId,Pe.config.id).then((e=>{const t=e.data||{};if(!t.data)return;const o={...JSON.parse(t.data),id:Pe.config.id};n(o)}))},n=t=>{const n={paramList:A(e.templateJson,{...t,id:Pe.config.id})||[]};N(e.interfaceId,n).then((e=>{ne.success(e.msg)}))};if(!e.useConfirm)return t();oe({iconType:"warning",title:ae("common.tipTitle"),content:e.confirmTitle||"确认执行此操作?",onOk:()=>{t()}})}(e.actionConfig),4==e.actionConfig.btnType&&function(e){const t=T(e.actionConfig.launchFlow),n={template:t.flowId,btnCode:e.value,currentUser:t.currentUser,customUser:t.customUser,initiator:t.initiator,dataList:[K(t.transferList,Pe.formData)]};H(Pe.config.modelId,n).then((e=>{ne.success(e.msg)}))}(e)}function ot(e){if(Pe.extraList[e]?.extraConfig)return Pe.extraKey=+new Date;Pe.extraLoading=!0,setTimeout((()=>{!function(e,t){if(!e)return Pe.extraLoading=!1;U({menuId:e,systemId:D.getUserInfo?.systemId}).then((e=>{if(200!==e.code||!e.data)return Pe.extraList[t].extraConfig="",Pe.extraLoading=!1,void(Pe.extraKey=+new Date);Pe.extraList[t].extraConfig=e.data,Pe.extraLoading=!1,Pe.extraKey=+new Date})).catch((()=>{Pe.extraLoading=!1,Pe.extraKey=+new Date}))}(Pe.extraList[e]?.targetFormId,e)}),200)}function at(e){Pe.detailVisible=!0,L((()=>{je.value?.init(e)}))}function it(e){Pe.formVisible=!0,L((()=>{Re.value?.init(e)}))}function rt(){Oe.value?.reload()}return c({init:function(e){Pe.loading=!0,Pe.config=e,Pe.formConf=T(e.formConf),Pe.customBtns=(Pe.formConf.customBtns||[]).reverse(),Pe.dataForm.id=e.id,Pe.extraActiveKey=0,Pe.extraConfig={},Pe.hideExtra=e.hideExtra||!1,function(){if(Pe.config.isPreview||Pe.config.isDataManage||!Pe.config.useFormPermission)return;const e=D.getPermissionList,t=Pe.config.menuId,n=e.filter((e=>e.modelId===t));Pe.formOperates=n[0]&&n[0].form?n[0].form:[]}(),Pe.extraList=Pe.formConf.detailExtraList?.length?[{fullName:Pe.config.title,id:0},...Pe.formConf.detailExtraList]:[],function(){if("fullScreen"===Pe.formConf.popupType)return se();if("drawer"===Pe.formConf.popupType)return Ie();he()}(),L((()=>{setTimeout(ze,0)}))}}),(e,t)=>{const c=g("a-button"),p=g("a-tab-pane"),m=g("a-tabs"),u=g("jnpf-empty"),_=g("Detail"),x=F("loading");return n(),i(l,null,[C(f($),s(e.$attrs,{onRegister:f(ie),title:f(Se),destroyOnClose:"",closeFunc:tt,class:"full-popup"}),{insertToolbar:a((()=>[f(Ae)?j("",!0):(n(!0),i(l,{key:0},r(Pe.customBtns,(e=>(n(),o(c,{class:"ml-10px",key:e.value,type:"primary",preIcon:e.actionConfig?.btnIcon,onClick:t=>nt(e)},{default:a((()=>[v(d(e.labelI18nCode?f(ae)(e.labelI18nCode,e.label):e.label),1)])),_:2},1032,["preIcon","onClick"])))),128)),f(Be).hasPrintBtn&&f(Be).printId?(n(),o(c,{key:1,class:"ml-10px",type:"primary",onClick:Xe},{default:a((()=>[v(d($e.value),1)])),_:1})):j("",!0)])),default:a((()=>[y("div",pe,[y("div",{class:"jnpf-common-form-wrapper__main",style:M({margin:"0 auto",width:f(Be).fullScreenWidth||"100%"})},[f(Ae)||!f(Ee).length||f(We)?j("",!0):(n(),i(l,{key:0},[C(m,{activeKey:f(Ue),"onUpdate:activeKey":t[0]||(t[0]=e=>R(Ue)?Ue.value=e:null),class:"jnpf-content-wrapper-tabs",destroyInactiveTabPane:"",onChange:ot},{default:a((()=>[(n(!0),i(l,null,r(f(Ee),((e,t)=>(n(),o(p,{key:t,tab:e.fullName},null,8,["tab"])))),128))])),_:1},8,["activeKey"]),y("div",me,[0==f(Ue)?(n(),o(Z,{class:"p-10px !pt-0px",ref_key:"parserRef",ref:Fe,formConf:f(Be),formData:f(Ve),onToDetail:Qe,key:f(Ke)},null,8,["formConf","formData"])):O((n(),i("div",ue,[f(Ee)[f(Ue)]?.extraConfig&&!f(He)?(n(),o(f(h),{ref_key:"extraListRef",ref:Oe,config:f(Ee)[f(Ue)],detailFormData:f(Ve),key:f(Je),onOpenDetail:at,onOpenForm:it},null,8,["config","detailFormData"])):j("",!0),f(Ee)[f(Ue)]?.extraConfig||f(He)?j("",!0):(n(),o(u,{key:1,class:"extra-empty"}))])),[[x,f(He)]])])],64)),f(Ae)||f(Ee).length&&!f(We)?j("",!0):(n(),o(Z,{class:"p-10px",ref_key:"parserRef",ref:Fe,formConf:f(Be),formData:f(Ve),onToDetail:Qe,key:f(Ke)},null,8,["formConf","formData"]))],4),Pe.dataForm.id&&f(Be).dataLog?(n(),o(ee,P(s({key:0},qe.value)),null,16)):j("",!0)])])),_:1},16,["onRegister","title"]),C(f(z),s(e.$attrs,{onRegister:f(ye),title:f(Se),width:f(Be).generalWidth,minHeight:100,showOkBtn:!1,closeFunc:tt}),{insertFooter:a((()=>[f(Ae)?j("",!0):(n(!0),i(l,{key:0},r(Pe.customBtns,(e=>(n(),o(c,{class:"ml-10px",key:e.value,type:"primary",preIcon:e.actionConfig?.btnIcon,onClick:t=>nt(e)},{default:a((()=>[v(d(e.labelI18nCode?f(ae)(e.labelI18nCode,e.label):e.label),1)])),_:2},1032,["preIcon","onClick"])))),128)),f(Be).hasPrintBtn&&f(Be).printId?(n(),o(c,{key:1,class:"ml-10px",type:"primary",onClick:Xe},{default:a((()=>[v(d($e.value),1)])),_:1})):j("",!0)])),default:a((()=>[f(Ae)?j("",!0):(n(),o(Z,{ref_key:"parserRef",ref:Fe,formConf:f(Be),formData:f(Ve),onToDetail:Qe,key:f(Ke)},null,8,["formConf","formData"]))])),_:1},16,["onRegister","title","width"]),C(f(X),s(e.$attrs,{onRegister:f(xe),title:f(Se),width:f(Be).drawerWidth,showFooter:"",showOkBtn:!1,closeFunc:tt}),{insertFooter:a((()=>[f(Ae)?j("",!0):(n(!0),i(l,{key:0},r(Pe.customBtns,(e=>(n(),o(c,{class:"ml-10px",key:e.value,type:"primary",preIcon:e.actionConfig?.btnIcon,onClick:t=>nt(e)},{default:a((()=>[v(d(e.labelI18nCode?f(ae)(e.labelI18nCode,e.label):e.label),1)])),_:2},1032,["preIcon","onClick"])))),128)),f(Be).hasPrintBtn&&f(Be).printId?(n(),o(c,{key:1,class:"ml-10px",type:"primary",onClick:Xe},{default:a((()=>[v(d($e.value),1)])),_:1})):j("",!0)])),default:a((()=>[y("div",_e,[f(Ae)?j("",!0):(n(),o(Z,{ref_key:"parserRef",ref:Fe,formConf:f(Be),formData:f(Ve),onToDetail:Qe,key:f(Ke)},null,8,["formConf","formData"]))])])),_:1},16,["onRegister","title","width"]),f(Ne)?(n(),o(_,{key:0,ref_key:"detailRef",ref:je,onClose:t[1]||(t[1]=e=>Pe.detailVisible=!1)},null,512)):j("",!0),f(Ye)?(n(),o(te,{key:1,ref_key:"formRef",ref:Re,onReload:rt},null,512)):j("",!0),C(fe,{onRegister:f(ke),onChange:Ze},null,8,["onRegister"]),C(ce,{onRegister:f(Te)},null,8,["onRegister"]),C(re,{ref_key:"customFormRef",ref:Me},null,512)],64)}}});export{fe as P,ge as _,ce as a};
