import{a as e,B as a}from"./index-9c138ba5.js";import{f as t}from"./formValidate-c8ab8d29.js";import{g as l,u as s,c as i}from"./msgTemplate-ce5c0fa7.js";import{d,ad as r,a0 as o,r as n,u as m,aD as u,M as c,e as p,o as f,p as g,l as y,j as k,k as h,a4 as v,ae as x,g as L,t as b,q as C,m as w,F,V as T,n as S,eg as _,ah as N}from"./index-920db443.js";import{u as I,B as U}from"./useForm-1d28ee0b.js";import"./componentMap-c91676b4.js";import{u as O,B as M}from"./index-143f5813.js";import{u as P,B as R}from"./useTable-dc8c9d84.js";const q={class:"parameter-box"},D={class:"left-pane"},J={class:"left-pane-list"},j={class:"list"},E={class:"search-box"},A=["onClick","title"],B=["onClick","title"],V=["onClick"],$=["onClick"],z={key:0,class:"right-pane"},H={key:1,class:"right-pane"},W={class:"msg-pane"},G={class:"list"},K=["onClick"],Q=d({__name:"Form",emits:["register","reload"],setup(d,{emit:Q}){const X=Q,Y=r({title:"",dataForm:{id:"",fullName:"",enCode:"",templateType:0,messageType:"",messageSource:"",enabledMark:1,sortCode:0,description:"",title:"",content:"",templateCode:"",wxSkip:"1",xcxAppId:""},dataRule:{fullName:[{required:!0,message:"必填",trigger:"blur"}],enCode:[{required:!0,message:"必填",trigger:"blur"},{validator:t("enCode"),trigger:"blur"}],messageSource:[{required:!0,message:"必填",trigger:"change"}],messageType:[{required:!0,message:"必填",trigger:"change"}],title:[{required:!0,message:"必填",trigger:"blur"}],content:[{required:!0,message:"必填",trigger:"blur"}],templateCode:[{required:!0,message:"必填",trigger:"blur"}],wxSkip:[{required:!0,message:"必填",trigger:"blur"}],xcxAppId:[{required:!0,message:"必填",trigger:"blur"}]},parameterList:[],allParameterList:[],smsList:[],messageTypeList:[],messageSourceList:[],keyword:"",wxSkipList:[{id:1,fullName:"小程序"},{id:2,fullName:"页面"}],isEdit:!1,tableScroll:{y:294}}),{dataForm:Z,dataRule:ee,messageTypeList:ae,messageSourceList:te,title:le,keyword:se,parameterList:ie,wxSkipList:de,smsList:re,isEdit:oe,tableScroll:ne}=o(Y),me=[{field:"@Title",fieldName:"标题"},{field:"@CreatorUserName",fieldName:"创建人"},{field:"@SendTime",fieldName:"发送时间"}],ue=[...me,{field:"@Content",fieldName:"内容"},{field:"@Remark",fieldName:"摘要"}],ce=[...me,{field:"@FlowLink",fieldName:"流程链接"},{field:"@Mandator",fieldName:"委托人"},{field:"@Mandatary",fieldName:"被委托人"}],pe=me,fe=[...me,{field:"@Content",fieldName:"内容"},{field:"@StartDate",fieldName:"开始日期"},{field:"@StartTime",fieldName:"开始时间"},{field:"@EndDate",fieldName:"结束日期"},{field:"@EndTime",fieldName:"结束时间"}],ge=n(),{t:ye}=m(),ke=u(),{createMessage:he,createConfirm:ve}=N(),[xe,{changeLoading:Le,changeOkLoading:be,closePopup:Ce}]=e((function(e){ge.value?.resetFields(),Y.dataForm={id:"",fullName:"",enCode:"",templateType:0,messageType:"",messageSource:"",enabledMark:1,sortCode:0,description:"",title:"",content:"",templateCode:"",wxSkip:1,xcxAppId:""},void(Y.smsList=[]),Y.dataForm.id=e.id||"",Y.title=Y.dataForm.id?ye("common.editText"):ye("common.addText"),Y.parameterList=[],Y.allParameterList=Y.parameterList,async function(){Y.messageTypeList=await ke.getDictionaryData("msgSendType"),Y.messageTypeList.map((e=>e.id=e.enCode)),Y.dataForm.messageType=Y.messageTypeList[0].id,Y.messageSourceList=await ke.getDictionaryData("msgSourceType"),Y.messageSourceList.map((e=>e.id=e.enCode))}(),Y.dataForm.id&&(Le(!0),l(Y.dataForm.id).then((e=>{Le(!1),e.data.smsFieldList.map((e=>{e.isTitle=!!e.isTitle})),Y.dataForm=e.data,Y.dataForm.wxSkip=Number(Y.dataForm.wxSkip),Y.parameterList=e.data.templateParamList,Y.allParameterList=Y.parameterList,Y.smsList=e.data.smsFieldList})).catch((()=>{Le(!1)})))})),[we]=P({columns:[{title:"参数名称",dataIndex:"field",key:"field",width:134},{title:"参数说明",dataIndex:"fieldName",key:"fieldName",width:134},{title:"操作",dataIndex:"action",key:"action",width:70}],useSearchForm:!1,showTableSetting:!1,pagination:!1,showHeader:!1,showIndexColumn:!1}),Fe=[{field:"field",label:"参数名称",component:"Input",componentProps:{placeholder:"请输入"},rules:[{required:!0,message:"必填",trigger:"blur"},{validator:t("field"),trigger:"blur"}]},{field:"fieldName",label:"参数说明",component:"Input",componentProps:{placeholder:"请输入"},rules:[{required:!0,message:"必填",trigger:"blur"}]}],[Te,{openModal:Se,closeModal:_e}]=O(),[Ne,{validate:Ie,setFieldsValue:Ue,updateSchema:Oe}]=I({labelWidth:100,schemas:Fe}),Me=c((()=>{const e=[{title:"序号",dataIndex:"index",key:"index",align:"center",width:50,customRender:({index:e})=>e+1},{title:"变量",dataIndex:"smsField",key:"smsField",helpMessage:["阿里云：在【阿里云管理后台-模板管理】维护模板变量参数","腾讯云：在【腾讯云管理后台-正⽂模板管理】维护模板变量参数"]},{title:"参数",dataIndex:"field",key:"field",width:200},{title:"标题",dataIndex:"isTitle",key:"isTitle",width:70,align:"center"},{title:"操作",dataIndex:"action",key:"action",width:70}];let a=[];return 3==Y.dataForm.messageType?a=e.filter((e=>"isTitle"!=e.key)):(a=e,a[1].helpMessage="在【微信公众号管理后台-广告与服务-模板消息】维护模板参数"),a}));function Pe(){Y.parameterList=Y.allParameterList.filter((e=>{if(e.field.toLowerCase().includes(Y.keyword.toLowerCase())||e.fieldName.toLowerCase().includes(Y.keyword.toLowerCase()))return e}))}function Re(e){const a="{"+e.field+"}";Y.dataForm.content+=a,Y.dataForm.title+=a,ge.value?.clearValidate(["title","content"])}function qe(e){Se(!0),e?(Y.isEdit=!0,S((()=>{Oe({field:"field",componentProps:{disabled:!0}}),Ue(e)}))):(Y.isEdit=!1,S((()=>Oe({field:"field",helpMessage:"可以使用大小写英文字母、数字、下划线组合，且不能数字、下划线开头。"}))))}async function De(){const e=await Ie();if(e){if(Y.isEdit){for(let a=0;a<Y.parameterList.length;a++)if(e.field===Y.parameterList[a].field){Y.parameterList[a]=e;break}}else{if(Y.parameterList.some((a=>a.field===e.field)))return he.error("参数名重复，请重新输入");Y.parameterList.push(e)}Y.allParameterList=Y.parameterList,_e()}}function Je(){Y.smsList.push({smsField:"",field:"",fieldId:_()})}function je(){Y.dataForm.content=""}async function Ee(){try{if(!(await(ge.value?.validate())))return;Y.dataForm.templateParamList=Y.parameterList||[],Y.dataForm.smsFieldList=JSON.parse(JSON.stringify(Y.smsList))||[];for(let t=0;t<Y.dataForm.smsFieldList.length;t++)Y.smsList[t].isTitle?Y.dataForm.smsFieldList[t].isTitle=1:Y.dataForm.smsFieldList[t].isTitle=0;be(!0);const e=Y.dataForm.id?s:i;let a=!0;for(let t=0;t<Y.dataForm.smsFieldList.length;t++){let e=Y.dataForm.smsFieldList[t];if(Y.dataForm.smsFieldList.filter((a=>a.smsField==e.smsField)).length>1){he.error(`第${t+1}行短信变量'${e.smsField}'已重复`),be(!1),a=!1;break}}a&&e(Y.dataForm).then((e=>{he.success(e.msg),Ce(),be(!1),X("reload")})).catch((()=>{be(!1)}))}catch(e){}}function Ae(){return"2"==Y.dataForm.messageSource?"系统参数格式：{@系统参数名}；自定义参数格式：{自定义参数名}":"系统参数格式：{@系统参数名}"}function Be(e){1==e&&(Y.parameterList=JSON.parse(JSON.stringify(ue))),2==e&&(Y.parameterList=JSON.parse(JSON.stringify(ce))),3==e&&(Y.parameterList=JSON.parse(JSON.stringify(pe))),4==e&&(Y.parameterList=JSON.parse(JSON.stringify(fe))),Y.allParameterList=Y.parameterList,Y.tableScroll=4==e?{y:314}:{y:294}}return(e,t)=>{const l=p("a-input"),s=p("a-form-item"),i=p("a-col"),d=p("jnpf-select"),r=p("a-switch"),o=p("a-input-number"),n=p("a-textarea"),m=p("a-input-search"),u=p("a-space"),c=p("a-button"),S=p("BasicHelp"),_=p("JnpfEditor"),N=p("a-row"),I=p("a-checkbox"),O=p("a-table"),P=p("a-form");return f(),g(h(a),T(e.$attrs,{onRegister:h(xe),showOkBtn:"",title:h(le),onOk:Ee,"destroy-on-close":""}),{default:y((()=>[k(P,{class:"!mx-20px",colon:!1,model:h(Z),rules:h(ee),ref_key:"formElRef",ref:ge,labelCol:{style:{width:"100px"}}},{default:y((()=>[k(N,{gutter:20},{default:y((()=>[k(i,{span:12},{default:y((()=>[k(s,{label:"名称",name:"fullName"},{default:y((()=>[k(l,{value:h(Z).fullName,"onUpdate:value":t[0]||(t[0]=e=>h(Z).fullName=e),placeholder:"请输入",allowClear:""},null,8,["value"])])),_:1})])),_:1}),k(i,{span:12},{default:y((()=>[k(s,{label:"编码",name:"enCode"},{default:y((()=>[k(l,{value:h(Z).enCode,"onUpdate:value":t[1]||(t[1]=e=>h(Z).enCode=e),placeholder:"请输入",allowClear:"",maxlength:50},null,8,["value"])])),_:1})])),_:1}),k(i,{span:12},{default:y((()=>[k(s,{label:"模板类型"},{default:y((()=>[k(l,{value:"自定义模板",disabled:"",allowClear:""})])),_:1})])),_:1}),k(i,{span:12},{default:y((()=>[k(s,{label:"消息来源",name:"messageSource"},{default:y((()=>[k(d,{value:h(Z).messageSource,"onUpdate:value":t[2]||(t[2]=e=>h(Z).messageSource=e),placeholder:"请选择",disabled:!!h(Z).id,options:h(te),onChange:Be},null,8,["value","disabled","options"])])),_:1})])),_:1}),k(i,{span:12},{default:y((()=>[k(s,{label:"消息类型",name:"messageType"},{default:y((()=>[k(d,{value:h(Z).messageType,"onUpdate:value":t[3]||(t[3]=e=>h(Z).messageType=e),placeholder:"请选择",disabled:!!h(Z).id,options:h(ae),onChange:je},null,8,["value","disabled","options"])])),_:1})])),_:1}),k(i,{span:12},{default:y((()=>[k(s,{label:"状态",name:"enabledMark"},{default:y((()=>[k(r,{checked:h(Z).enabledMark,"onUpdate:checked":t[4]||(t[4]=e=>h(Z).enabledMark=e),checkedValue:1,unCheckedValue:0},null,8,["checked"])])),_:1})])),_:1}),k(i,{span:12},{default:y((()=>[k(s,{label:"排序",name:"sortCode"},{default:y((()=>[k(o,{min:0,max:999999,value:h(Z).sortCode,"onUpdate:value":t[5]||(t[5]=e=>h(Z).sortCode=e),placeholder:"请输入"},null,8,["value"])])),_:1})])),_:1}),k(i,{span:24},{default:y((()=>[k(s,{label:"说明",name:"description"},{default:y((()=>[k(n,{value:h(Z).description,"onUpdate:value":t[6]||(t[6]=e=>h(Z).description=e),placeholder:"请输入",type:"textarea",rows:3},null,8,["value"])])),_:1})])),_:1}),k(i,{span:24},{default:y((()=>[v("div",q,[v("div",D,[v("div",J,[v("div",j,[t[15]||(t[15]=v("div",{class:"header"},[v("span",null,"参数名称"),v("span",null,"参数说明"),v("span",{class:"operation"},"操作")],-1)),v("div",E,[k(m,{class:"search",value:h(se),"onUpdate:value":t[7]||(t[7]=e=>x(se)?se.value=e:null),placeholder:"输入关键字",allowClear:"",onInput:Pe},null,8,["value"])]),k(h(R),{onRegister:h(we),"data-source":h(ie),scroll:h(ne)},{bodyCell:y((({column:e,record:a,index:t})=>{return["field"===e.key?(f(),L("span",{key:0,onClick:e=>Re(a),class:"cursor-pointer",title:a.field},b(a.field),9,A)):C("",!0),"fieldName"===e.key?(f(),L("span",{key:1,onClick:e=>Re(a),class:"cursor-pointer",title:a.fieldName},b(a.fieldName),9,B)):C("",!0),"action"!==e.key||(l=a.field,l&&l.startsWith("@"))?C("",!0):(f(),g(u,{key:2,size:10},{default:y((()=>[v("i",{class:"icon-ym icon-ym-btn-edit",onClick:e=>qe(a)},null,8,V),v("i",{class:"icon-ym icon-ym-delete",onClick:e=>function(e){ve({iconType:"warning",title:ye("common.tipTitle"),content:"此操作删除该参数, 不能恢复，是否继续?",onOk:()=>{Y.parameterList.splice(e,1),Y.allParameterList=Y.parameterList}})}(t)},null,8,$)])),_:2},1024))];var l})),_:1},8,["onRegister","data-source","scroll"])]),"2"===h(Z).messageSource?(f(),L("div",{key:0,class:"table-add-action",onClick:t[8]||(t[8]=e=>qe())},[k(c,{type:"link",preIcon:"icon-ym icon-ym-btn-add"},{default:y((()=>[w(b(h(ye)("common.addText")),1)])),_:1})])):C("",!0)])]),3!=h(Z).messageType&&7!=h(Z).messageType?(f(),L("div",z,[k(s,{name:"title"},{label:y((()=>[t[16]||(t[16]=w("消息标题")),k(S,{text:Ae()},null,8,["text"])])),default:y((()=>[k(l,{value:h(Z).title,"onUpdate:value":t[9]||(t[9]=e=>h(Z).title=e),placeholder:"请输入",allowClear:""},null,8,["value"])])),_:1}),2==h(Z).messageType?(f(),g(s,{key:0,name:"content"},{label:y((()=>[t[17]||(t[17]=w("消息内容")),k(S,{text:Ae()},null,8,["text"])])),default:y((()=>[k(_,{value:h(Z).content,"onUpdate:value":t[10]||(t[10]=e=>h(Z).content=e)},null,8,["value"])])),_:1})):1!=h(Z).messageType?(f(),g(s,{key:1,name:"content"},{label:y((()=>[t[18]||(t[18]=w("消息内容")),k(S,{text:Ae()},null,8,["text"])])),default:y((()=>[k(n,{value:h(Z).content,"onUpdate:value":t[11]||(t[11]=e=>h(Z).content=e),placeholder:"请输入",rows:16},null,8,["value"])])),_:1})):C("",!0)])):(f(),L("div",H,[k(N,{gutter:20},{default:y((()=>[k(i,{span:12},{default:y((()=>[k(s,{name:"templateCode"},{label:y((()=>[t[19]||(t[19]=w(" 模板编号 ")),k(S,{text:3==h(Z).messageType?["阿里云：请在【阿里云管理后台-模板管理】⻚⾯查看模板CODE","腾讯云：请在【腾讯云管理后台-正⽂模板管理】⻚⾯查看模板ID"]:"在【微信公众号管理后台-广告与服务-模板消息】⻚⾯查看模板ID"},null,8,["text"])])),default:y((()=>[k(l,{value:h(Z).templateCode,"onUpdate:value":t[12]||(t[12]=e=>h(Z).templateCode=e),placeholder:"请输入"},null,8,["value"])])),_:1})])),_:1}),k(i,{span:12,offset:"12"}),7==h(Z).messageType?(f(),g(i,{key:0,span:12},{default:y((()=>[k(s,{label:"跳转方式",name:"wxSkip"},{default:y((()=>[k(d,{value:h(Z).wxSkip,"onUpdate:value":t[13]||(t[13]=e=>h(Z).wxSkip=e),placeholder:"请选择",options:h(de)},null,8,["value","options"])])),_:1})])),_:1})):C("",!0),7==h(Z).messageType&&1==h(Z).wxSkip?(f(),g(i,{key:1,span:12},{default:y((()=>[k(s,{name:"xcxAppId",labelCol:{style:{width:"120px"}}},{label:y((()=>[t[20]||(t[20]=w("关联小程序ID")),k(S,{text:"请在【微信公众号管理后台-广告与服务-小程序管理】⻚⾯查看小程序ID"})])),default:y((()=>[k(l,{value:h(Z).xcxAppId,"onUpdate:value":t[14]||(t[14]=e=>h(Z).xcxAppId=e),placeholder:"请输入",allowClear:""},null,8,["value"])])),_:1})])),_:1})):C("",!0)])),_:1}),v("div",W,[v("div",G,[k(O,{"data-source":h(re),columns:Me.value,size:"small",pagination:!1},{headerCell:y((({column:e})=>["smsField"===e.key?(f(),L(F,{key:0},[v("span",null,b(e.title),1),k(S,{text:e.helpMessage},null,8,["text"])],64)):C("",!0)])),bodyCell:y((({column:e,record:a,index:t})=>["smsField"===e.key?(f(),g(l,{key:0,value:a.smsField,"onUpdate:value":e=>a.smsField=e,placeholder:"请输入",allowClear:""},null,8,["value","onUpdate:value"])):C("",!0),"field"===e.key?(f(),g(d,{key:1,value:a.field,"onUpdate:value":e=>a.field=e,placeholder:"请选择",options:h(ie),fieldNames:{label:"field",value:"field"},allowClear:""},null,8,["value","onUpdate:value","options"])):C("",!0),"isTitle"===e.key?(f(),g(I,{key:2,checked:a.isTitle,"onUpdate:checked":e=>a.isTitle=e,onChange:e=>function(e,a){if(e){for(let e=0;e<Y.smsList.length;e++)Y.smsList[e].isTitle=!1;Y.smsList[a].isTitle=!0}}(e,t)},null,8,["checked","onUpdate:checked","onChange"])):C("",!0),"action"===e.key?(f(),L("i",{key:3,class:"icon-ym icon-ym-delete",danger:"",onClick:e=>function(e){Y.smsList.splice(e,1)}(t)},null,8,K)):C("",!0)])),_:1},8,["data-source","columns"])]),v("div",{class:"table-add-action",onClick:Je},[k(c,{type:"link",preIcon:"icon-ym icon-ym-btn-add"},{default:y((()=>t[21]||(t[21]=[w("添加一行")]))),_:1,__:[21]})])])]))])])),_:1})])),_:1})])),_:1},8,["model","rules"]),k(h(M),{onRegister:h(Te),title:h(oe)?h(ye)("common.editText"):h(ye)("common.addText"),showOkBtn:"",onOk:De,destroyOnClose:""},{default:y((()=>[k(h(U),{onRegister:h(Ne)},null,8,["onRegister"])])),_:1},8,["onRegister","title"])])),_:1},16,["onRegister","title"])}}});export{Q as _};
