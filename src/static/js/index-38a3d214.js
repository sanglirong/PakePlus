import{d as t,ad as e,aA as n,a6 as a,aw as i,M as s,a7 as r,o,g as d,a4 as p,n as l,dk as m,co as f,k as c}from"./index-920db443.js";import{$ as u,a as h}from"./jquery-6353a699.js";import{u as I}from"./document-763aa4ad.js";import{u as w}from"./useDefineSetting-7df030ff.js";const g={class:"jnpf-content-wrapper"},D=t({__name:"index",setup(t){const D=e({id:"",formId:"",taskId:"",hiprintTemplate:void 0,dataList:[],systemInfo:{printer:"",printTime:""}}),T=n(),v=a(),{getFlowStateContent:Y}=w(),k=i(),y=s((()=>v.getUserInfo||{}));function H(){const t=T.query;D.id=t?.pId,D.formId=t?.fId,D.taskId=t?.tId,t.token&&D.id&&D.formId&&D.taskId&&(v.updateToken(t.token),l((()=>{!async function(){u("#previewDesignedWrap").html(null);const{data:t}=await h({id:D.id,formInfo:[{formId:D.formId,flowTaskId:D.taskId}]})||{};if(!t)return;!function(){const t=c(y).userName+"/"+c(y).userAccount,e=f((new Date).getTime()).format("YYYY-MM-DD HH:mm:ss");D.systemInfo.printer=t,D.systemInfo.printTime=e}();const e=t?.map(((t,e)=>{let{printData:n,printTemplate:a,operatorRecordList:i=[],convertConfig:s=""}=t||{};try{const t=JSON.parse(a);return 0===e&&(D.hiprintTemplate=new m.hiprint.PrintTemplate({template:t})),s&&(n=function(t,e){const n=JSON.parse(e);for(let a=0;a<n.length;a++){const e=n[a];if("singleImg"!==e.type)continue;const i=e.field.split(".")[0],s=e.field.split(".")[1];if(Reflect.has(t,i))for(let n=0;n<t[i].length;n++)Reflect.has(t[i][n],s)&&t[i][n][s]&&(t[i][n][s]=k.apiUrl+t[i][n][s])}return t}(n,s)),n.operatorRecordList=i.map((t=>({...t,handleTime:f(t.handleTime).format("YYYY-MM-DD HH:mm:ss"),handleStatus:Y(t.handleStatus)}))),n.systemInfo=D.systemInfo,n}catch(r){return u("#previewDesignedWrap").append('<div class="print-single-wrap"><div class="tpl-invalid">模板已失效，请重新设计</div></div>'),null}}));if(!D.hiprintTemplate)return;D.dataList=[...e],function(){if(!window.hinnn)return;window.hinnn.apiUrl=k.apiUrl,window.hinnn.dateFormat=function(t,e){return t?(isNaN(t)||"string"!=typeof t||(t=Number(t)),e=e.replaceAll("y","Y").replaceAll("d","D"),f(t).format(e)):""}}();const n=D.hiprintTemplate?.getHtml(D.dataList);u("#previewDesignedWrap").html(n),function(){if(!D.hiprintTemplate||!D.dataList?.length)return;D.hiprintTemplate?.toPdf(D.dataList,`${D.id}_${f().format("YYYYMMDDHHmmss")}`,{isDownload:!1}).then((t=>{const e=new FormData;e.append("file",t),e.append("taskId",D.taskId),I(e).then((()=>{window.close()}))}))}()}()})))}return r((()=>{H()})),(t,e)=>(o(),d("div",g,e[0]||(e[0]=[p("div",{id:"previewDesignedWrap"},null,-1)])))}});export{D as default};
