import{a as e,B as t}from"./index-9c138ba5.js";import{u as a,B as n}from"./useForm-1d28ee0b.js";import"./componentMap-c91676b4.js";import{g as l,a as o,u as r,c as s}from"./task-ed891400.js";import{d as i,r as u,u as d,M as c,k as m,ad as p,a0 as f,e as g,o as x,p as v,l as C,j as y,m as h,g as k,F as T,a4 as b,t as N,q as I,V as w,ah as _}from"./index-920db443.js";import{a as F}from"./index-c37d2476.js";import{f as P}from"./formValidate-c8ab8d29.js";const j={class:"required-sign"},U=i({name:"system-task",__name:"Form",emits:["register","reload"],setup(i,{emit:U}){const M=U,q=u(""),{createMessage:H}=_(),{t:S}=d(),O=c((()=>m(q)?S("common.editText"):S("common.addText"))),Y=p({taskOptions:[],interfaceName:""}),{interfaceName:V}=f(Y),D=[{field:"fullName",label:"任务名称",component:"Input",componentProps:{placeholder:"请输入"},rules:[{required:!0,trigger:"blur",message:"必填"}]},{field:"enCode",label:"任务编码",component:"Input",componentProps:{placeholder:"请输入"},rules:[{required:!0,trigger:"blur",message:"必填"},{validator:P("enCode","只能输入英文、数字和小数点且小数点不能放在首尾"),trigger:"blur"}]},{field:"executeContent.cron",label:"Cron表达式",component:"Input",slot:"taskCron",rules:[{required:!0,trigger:"blur",message:"必填"}]},{field:"executeContent.startTime",label:"任务开始时间",component:"DatePicker",componentProps:{format:"YYYY-MM-DD HH:mm:ss"},rules:[{required:!0,trigger:"change",message:"必填"},{validator:(e,t)=>$().executeContent?.endTime&&t?$().executeContent?.endTime<t?Promise.reject("任务结束时间不能早于任务开始时间"):(L(["executeContent.endTime"]),Promise.resolve()):Promise.resolve(),trigger:"change"}]},{field:"executeContent.endTime",label:"任务结束时间",component:"DatePicker",componentProps:{format:"YYYY-MM-DD HH:mm:ss"},helpMessage:"未选结束时间即为永久期限",rules:[{validator:(e,t)=>$().executeContent?.startTime&&t&&$().executeContent?.startTime>t?Promise.reject("任务结束时间不能早于任务开始时间"):Promise.resolve(),trigger:"change"}]},{field:"executeType",label:"任务类型",slot:"taskType",defaultValue:"1",component:"Input"},{ifShow:({values:e})=>1==e.executeType,field:"executeContent.interfaceId",label:"数据接口",slot:"interfaceId",component:"Select",rules:[{required:!0,trigger:"change",message:"必填"}]},{ifShow:({values:e})=>1==e.executeType&&!!e["executeContent.parameter"]?.length,field:"executeContent.parameter",label:" ",slot:"parameter",component:"Select"},{ifShow:({values:e})=>3==e.executeType,field:"executeContent.localHostTaskId",label:"方法选择",component:"Select",componentProps:{options:Y.taskOptions},rules:[{required:!0,trigger:"change",message:"必填"}]},{field:"enabledMark",label:"任务状态",defaultValue:1,component:"Switch"},{field:"description",label:"任务说明",component:"Textarea"}],R=[{title:"序号",width:50,align:"center",customRender:({index:e})=>e+1},{title:"参数名称",dataIndex:"field",key:"field",width:120},{title:"参数来源",dataIndex:"sourceType",key:"sourceType",width:120},{title:"参数值",dataIndex:"relationField",key:"relationField"}],[B,{setFieldsValue:J,validate:L,clearValidate:z,resetFields:A,updateSchema:W,getFieldsValue:$}]=a({labelWidth:120,schemas:D}),[E,{closePopup:G,changeLoading:K,changeOkLoading:Q}]=e((function(e){A(),q.value=e.id,K(!0),l().then((e=>{Y.taskOptions=e.data||[],W([{field:"executeContent.localHostTaskId",componentProps:{options:Y.taskOptions}}]),q.value?o(q.value).then((e=>{const t=e.data;t.executeContent=JSON.parse(t.executeContent),Y.interfaceName=t.executeContent.interfaceName,J(t),K(!1)})).catch((()=>{K(!1)})):K(!1)})).catch((()=>{K(!1)}))}));async function X(){const e=await L();if(!e)return;Q(!0);let t=$().executeContent;t.parameter=e["executeContent.parameter"],t.interfaceName=Y.interfaceName,t=JSON.stringify(t);let a={...$(),executeContent:t,id:q.value};(q.value?r:s)(a).then((e=>{H.success(e.msg),Q(!1),G(),M("reload")})).catch((()=>{Q(!1)}))}function Z(e,t){$().executeContent?.interfaceId!==e&&(Y.interfaceName=t.fullName,J({"executeContent.interfaceId":e||"","executeContent.interfaceName":t.fullName||"","executeContent.parameter":t.templateJson.map((e=>({...e,sourceType:2})))||""}),z("executeContent.interfaceId"))}function ee(){J({"executeContent.interfaceId":"","executeContent.interfaceName":"","executeContent.parameter":[],"executeContent.localHostTaskId":""})}function te(){z("executeContent.cron")}function ae(e){const t=[{id:2,fullName:"自定义"},{id:3,fullName:"为空"}];return e?t.filter((e=>3!=e.id)):t}return(e,a)=>{const l=g("JnpfCron"),o=g("a-radio"),r=g("BasicHelp"),s=g("a-radio-group"),i=g("jnpf-select"),u=g("jnpf-input-number"),d=g("jnpf-date-picker"),c=g("a-input"),p=g("a-table"),f=g("a-form-item-rest"),_=g("a-col"),P=g("a-row");return x(),v(m(t),w(e.$attrs,{onRegister:m(E),title:O.value,showOkBtn:"",onOk:X}),{default:C((()=>[y(P,{class:"mt-20px"},{default:C((()=>[y(_,{span:"14",offset:"5"},{default:C((()=>[y(m(n),{onRegister:m(B)},{taskCron:C((({model:e,field:t})=>[y(l,{value:e[t],"onUpdate:value":a=>e[t]=a,onChange:te},null,8,["value","onUpdate:value"])])),taskType:C((({model:e,field:t})=>[y(s,{value:e[t],"onUpdate:value":a=>e[t]=a,onChange:ee},{default:C((()=>[y(o,{value:"1"},{default:C((()=>a[0]||(a[0]=[h("数据接口")]))),_:1,__:[0]}),y(o,{value:"3"},{default:C((()=>[a[1]||(a[1]=h("本地任务")),y(r,{text:"获取在程序中事先写好的本地方法"})])),_:1,__:[1]})])),_:2},1032,["value","onUpdate:value"])])),interfaceId:C((({model:e,field:t})=>[y(m(F),{value:e[t],title:m(V),sourceType:3,onChange:Z},null,8,["value","title"])])),parameter:C((({model:e,field:t})=>[y(f,null,{default:C((()=>[y(p,{"data-source":e[t],columns:R,size:"small",pagination:!1},{bodyCell:C((({column:e,record:t})=>["field"===e.key?(x(),k(T,{key:0},[b("span",j,N(t.required?"*":""),1),h(" "+N(t.field)+N(t.fieldName?"("+t.fieldName+")":""),1)],64)):I("",!0),"sourceType"===e.key?(x(),v(i,{key:1,value:t.sourceType,"onUpdate:value":e=>t.sourceType=e,options:ae(t.required),class:"!w-100px",disabled:t.disabled},null,8,["value","onUpdate:value","options","disabled"])):I("",!0),"relationField"===e.key?(x(),k(T,{key:2},[2==t.sourceType?(x(),k(T,{key:0},["int"===t.dataType||"decimal"===t.dataType?(x(),v(u,{key:0,value:t.relationField,"onUpdate:value":e=>t.relationField=e,placeholder:"请输入",allowClear:""},null,8,["value","onUpdate:value"])):"datetime"===t.dataType?(x(),v(d,{key:1,class:"!w-full",value:t.relationField,"onUpdate:value":e=>t.relationField=e,placeholder:"请选择",format:"yyyy-MM-dd HH:mm:ss",allowClear:""},null,8,["value","onUpdate:value"])):(x(),v(c,{key:2,value:t.relationField,"onUpdate:value":e=>t.relationField=e,placeholder:"请输入",allowClear:""},null,8,["value","onUpdate:value"]))],64)):I("",!0)],64)):I("",!0)])),_:2},1032,["data-source"])])),_:2},1024)])),_:1},8,["onRegister"])])),_:1})])),_:1})])),_:1},16,["onRegister","title"])}}});export{U as _};
