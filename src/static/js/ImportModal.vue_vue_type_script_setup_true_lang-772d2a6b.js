import{d as e,ad as t,a0 as a,u as s,aw as i,M as l,dD as n,k as o,e as r,o as c,p as d,l as p,m as u,t as m,q as f,a4 as v,j as g,ae as y,i as x,e6 as _,v as k,g as h,F as w,h as b,V as L,ea as C,ah as I}from"./index-920db443.js";import{_ as N,a as S}from"./import-e198d900.js";import{_ as P,a as R}from"./tip-b30e67af.js";import{b as T,B as j}from"./index-143f5813.js";import{i as U}from"./config-900ef1e2.js";const z={class:"header-steps"},D={class:"import-main"},O={class:"upload"},M={class:"up_right"},B={class:"upload"},E={class:"up_right"},F={class:"import-main"},G={class:"import-main"},K={key:0,class:"success"},$={class:"success-tip"},q={key:1,class:"unsuccess"},A={class:"upload error-show"},V={class:"up_right"},H={class:"tip success-tip"},J={class:"tip error-tip"},Q={class:"conTips"},W=e({__name:"ImportModal",emits:["register","reload"],setup(e,{emit:W}){const X=t({activeStep:0,fileName:"",fileList:[],btnLoading:!1,list:[],result:{},resultList:[],type:"user",skipPreview:!1}),{activeStep:Y,fileName:Z,fileList:ee,btnLoading:te,list:ae,result:se,resultList:ie,skipPreview:le}=a(X),ne=W,[oe,{closeModal:re}]=T((function(e){X.type=e.type||"user",X.activeStep=0,X.fileName="",X.fileList=[],X.btnLoading=!1,X.skipPreview=!1})),{createMessage:ce,createConfirm:de}=I(),{t:pe}=s(),ue=i(),me=l((()=>ue.apiUrl+U[X.type].uploadUrl)),fe=l((()=>({Authorization:n()}))),ve=l((()=>U[X.type].tableData)),ge=l((()=>[{width:50,title:"序号",align:"center",customRender:({index:e})=>e+1},...o(ve),{title:"操作",dataIndex:"action",key:"action",width:50,fixed:"right"}])),ye=l((()=>[{width:50,title:"序号",align:"center",customRender:({index:e})=>e+1},...o(ve),{title:"异常原因",dataIndex:"errorsInfo",width:150,fixed:"right"}]));function xe(){0!=X.activeStep&&(X.activeStep-=1)}function _e(){if(0==X.activeStep)return X.fileList.length&&X.fileName?X.skipPreview?ke():(X.btnLoading=!0,void U[X.type].importPreview({fileName:X.fileName}).then((e=>{X.list=e.data.dataRow||[],X.btnLoading=!1,X.activeStep+=1})).catch((()=>{X.btnLoading=!1}))):ce.warning("请先上传文件");if(1==X.activeStep){if(!X.list.length)return ce.warning("导入数据为空");ke()}}function ke(){X.btnLoading=!0;let e={list:X.list};X.skipPreview&&(e={...e,type:X.skipPreview,fileName:X.fileName}),U[X.type].importData(e).then((e=>{X.result=e.data,X.resultList=e.data.failResult,X.activeStep+=1,X.skipPreview&&(X.activeStep=2),X.btnLoading=!1})).catch((()=>{X.btnLoading=!1}))}function he({file:e}){"error"!==e.status?"done"===e.status&&(200===e.response.code?X.fileName=e.response.data.name:ce.error(e.response.msg)):ce.error("上传失败")}function we(e){const t=e.name.replace(/.+\./,"");if(!(-1!==["xls","xlsx"].indexOf(t.toLowerCase())))return ce.error("文件格式不正确"),_.LIST_IGNORE;return!!(e.size/1024<500)||(ce.error("文件大小超过500KB"),_.LIST_IGNORE)}function be(e){return new Promise(((t,a)=>{de({iconType:"warning",title:pe("common.tipTitle"),content:`确定移除${e.name}?`,onOk:()=>{X.fileName="",t()},onCancel:()=>{a()}})}))}function Le(e=!1){re(),e&&ne("reload")}return(e,t)=>{const a=r("a-step"),s=r("a-steps"),i=r("a-button"),l=r("a-switch"),n=r("a-form-item"),I=r("a-input"),T=r("a-table");return c(),d(o(j),L(e.$attrs,{onRegister:o(oe),title:"批量导入",width:1e3,"show-cancel-btn":!1,"show-ok-btn":!1,destroyOnClose:"",class:"jnpf-import-modal"}),{insertFooter:p((()=>[0==o(Y)?(c(),d(i,{key:0,onClick:t[5]||(t[5]=e=>Le())},{default:p((()=>[u(m(o(pe)("common.cancelText")),1)])),_:1})):f("",!0),1===o(Y)?(c(),d(i,{key:1,onClick:xe},{default:p((()=>[u(m(o(pe)("common.prev")),1)])),_:1})):f("",!0),o(Y)<2?(c(),d(i,{key:2,type:"primary",onClick:_e,loading:o(te),disabled:0===o(Y)&&!o(Z)},{default:p((()=>[u(m(o(pe)("common.next")),1)])),_:1},8,["loading","disabled"])):(c(),d(i,{key:3,type:"primary",onClick:t[6]||(t[6]=e=>Le(!0))},{default:p((()=>t[23]||(t[23]=[u("关闭")]))),_:1,__:[23]}))])),default:p((()=>[v("div",z,[g(s,{current:o(Y),"onUpdate:current":t[0]||(t[0]=e=>y(Y)?Y.value=e:null),type:"navigation",size:"small"},{default:p((()=>[g(a,{title:"上传文件",disabled:""}),g(a,{title:"数据预览",disabled:""}),g(a,{title:"导入数据",disabled:""})])),_:1},8,["current"])]),x(v("div",D,[v("div",O,[t[10]||(t[10]=v("div",{class:"up_left"},[v("img",{src:N})],-1)),v("div",M,[t[8]||(t[8]=v("p",{class:"title"},"上传填好的数据表",-1)),t[9]||(t[9]=v("p",{class:"tip"},"文件后缀名必须是xls或xlsx，文件大小不超过500KB，最多支持导入1000条数据",-1)),g(o(_),{"file-list":o(ee),"onUpdate:fileList":t[1]||(t[1]=e=>y(ee)?ee.value=e:null),class:"upload-area",accept:".xls,.xlsx","max-count":1,action:me.value,headers:fe.value,"before-upload":we,onRemove:be,onChange:he},{default:p((()=>[g(i,{type:"link"},{default:p((()=>t[7]||(t[7]=[u("上传文件")]))),_:1,__:[7]})])),_:1},8,["file-list","action","headers"])])]),v("div",B,[t[14]||(t[14]=v("div",{class:"up_left"},[v("img",{src:S})],-1)),v("div",E,[t[12]||(t[12]=v("p",{class:"title"},"填写导入数据信息",-1)),t[13]||(t[13]=v("p",{class:"tip"},"请按照数据模板的格式准备导入数据，模板中的表头名称不可更改，表头行不能删除",-1)),g(i,{type:"link",onClick:t[2]||(t[2]=e=>{U[X.type].templateDownload().then((e=>{C({url:e.data?.url})}))})},{default:p((()=>t[11]||(t[11]=[u("下载模板")]))),_:1,__:[11]})])]),g(n,{colon:!1,label:"跳过数据预览"},{default:p((()=>[g(l,{checked:o(le),"onUpdate:checked":t[3]||(t[3]=e=>y(le)?le.value=e:null)},null,8,["checked"])])),_:1})],512),[[k,0==o(Y)]]),x(v("div",F,[g(T,{"data-source":o(ae),columns:ge.value,size:"small",pagination:!1,scroll:{x:"max-content",y:"420px"},class:"import-preview-table"},{bodyCell:p((({column:e,record:a,index:s})=>[(c(!0),h(w,null,b(ve.value,(t=>(c(),h(w,null,[e.dataIndex===t.dataIndex?(c(),d(I,{key:0,value:a[e.dataIndex],"onUpdate:value":t=>a[e.dataIndex]=t},null,8,["value","onUpdate:value"])):f("",!0)],64)))),256)),"action"===e.dataIndex?(c(),d(i,{key:0,class:"action-btn",type:"link",color:"error",onClick:e=>function(e){X.list.splice(e,1)}(s),size:"small"},{default:p((()=>t[15]||(t[15]=[u("删除")]))),_:2,__:[15]},1032,["onClick"])):f("",!0)])),_:1},8,["data-source","columns"])],512),[[k,1==o(Y)]]),x(v("div",G,[o(se).resultType?f("",!0):(c(),h("div",K,[t[16]||(t[16]=v("img",{src:P},null,-1)),t[17]||(t[17]=v("p",{class:"success-title"},"批量导入成功",-1)),v("p",$,"您已成功导入"+m(o(se).snum)+"条数据",1)])),o(se).resultType?(c(),h("div",q,[v("div",A,[t[20]||(t[20]=v("div",{class:"up_left"},[v("img",{src:R})],-1)),v("div",V,[v("p",H,[t[18]||(t[18]=u(" 正常数据条数：")),v("span",null,m(o(se).snum)+"条",1)]),v("p",J,[t[19]||(t[19]=u(" 异常数据条数：")),v("span",null,m(o(se).fnum)+"条",1)])])]),v("div",Q,[t[22]||(t[22]=v("p",null,"以下文件数据为导入异常数据",-1)),g(i,{type:"link",preIcon:"icon-ym icon-ym-btn-download",onClick:t[4]||(t[4]=e=>{U[X.type].exportExceptionData({list:X.resultList}).then((e=>{C({url:e.data?.url})}))})},{default:p((()=>t[21]||(t[21]=[u("导出异常数据")]))),_:1,__:[21]})]),g(T,{"data-source":o(ie),columns:ye.value,size:"small",pagination:!1,scroll:{x:"max-content",y:"205px"}},null,8,["data-source","columns"])])):f("",!0)],512),[[k,2==o(Y)]])])),_:1},16,["onRegister"])}}});export{W as _};
