import{A as e,B as t,C as o,D as a,E as n,F as s,n as l,G as d}from"./task-ee77df5a.js";import{a as i,B as r}from"./index-9c138ba5.js";import{u as c,B as p}from"./useTable-dc8c9d84.js";import{d as f,aD as u,u as m,ad as g,w as h,e as w,o as b,p as y,l as C,j as _,k as D,m as I,g as k,F as T,q as B,t as S,V as R,ah as x}from"./index-920db443.js";import{u as v}from"./useDefineSetting-7df030ff.js";import{u as M}from"./index-143f5813.js";import{_ as P}from"./ApprovalModal.vue_vue_type_script_setup_true_lang-8440f311.js";import{_ as j}from"./ActionModal.vue_vue_type_script_setup_true_lang-22457a03.js";import{_ as F}from"./ErrorModal.vue_vue_type_script_setup_true_lang-581230da.js";const L=f({__name:"BatchList",emits:["register"],setup(f){const L=u(),{createMessage:V}=x(),{t:N}=m(),[U]=i((function(){ae.nodeCode="",re(),async function(){const e=await L.getDictionaryData("businessType");se().updateSchema({field:"flowCategory",componentProps:{options:e}}),t().then((e=>{se().updateSchema({field:"templateId",componentProps:{options:e.data}})}))}(),ae.allBtnDisabled=!1,ae.clickReset=!1})),[Y,{openModal:A,closeModal:H}]=M(),[K,{openModal:q,closeModal:E,setModalProps:G}]=M(),[J,{openModal:O,closeModal:$,setModalProps:z}]=M(),{getUrgentText:Q,getUrgentTextColor:W,getHandlingStatusContent:X,getHandlingStatusColor:Z}=v(),ee=[{title:"流程标题",dataIndex:"fullName",width:200},{title:"所属流程",dataIndex:"flowName",width:150},{title:"流程版本",dataIndex:"flowVersion",width:130,align:"center"},{title:"发起时间",dataIndex:"startTime",width:150,format:"date|YYYY-MM-DD HH:mm:ss"},{title:"发起人员",dataIndex:"creatorUser",width:120},{title:"审批节点",dataIndex:"currentNodeName",width:150},{title:"紧急程度",dataIndex:"flowUrgent",width:100,align:"center"},{title:"流程状态",dataIndex:"status",width:120,align:"center"},{title:"接收时间",dataIndex:"creatorTime",width:150,format:"date|YYYY-MM-DD HH:mm:ss"}],te={branchList:[],fileList:[],handleOpinion:"",signImg:"",copyIds:"",backNodeCode:"",backType:1},oe=g({category:5}),ae=g({batchType:0,candidateType:1,allBtnDisabled:!1,approvalData:{},flowId:"",nodeCode:"",clickReset:!1}),[ne,{getForm:se,reload:le,getSelectRows:de,getSelectRowKeys:ie,clearSelectedRowKeys:re,setTableData:ce}]=c({api:e,searchInfo:oe,useSearchForm:!0,formConfig:{schemas:[{field:"templateId",label:"所属流程",component:"Select",componentProps:{showSearch:!0,onChange:function(e){if(ae.nodeCode="",se().setFieldsValue({flowId:"",nodeCode:""}),se().updateSchema([{field:"flowId",componentProps:{options:[]}}]),se().updateSchema([{field:"nodeCode",componentProps:{options:[]}}]),!e)return;!function(e){o(e).then((e=>{se().updateSchema({field:"flowId",componentProps:{options:e.data}})}))}(e)}}},{field:"flowId",label:"所属版本",component:"Select",componentProps:{showSearch:!0,onChange:function(e){if(ae.nodeCode="",se().setFieldsValue({nodeCode:""}),se().updateSchema({field:"nodeCode",componentProps:{options:[]}}),!e)return;!function(e){a(e).then((e=>{se().updateSchema({field:"nodeCode",componentProps:{options:e.data}})}))}(e)},onDropdownVisibleChange:function(e){if(!e)return;se().getFieldsValue().templateId||V.warning("请先选择所属流程")}}},{field:"nodeCode",label:"所属节点",component:"Select",componentProps:{showSearch:!0,onChange:function(e){ae.nodeCode=e||""},onDropdownVisibleChange:function(e){if(!e)return;se().getFieldsValue().flowId||V.warning("请先选择所属版本")}}}],submitFunc:async()=>{if(ce([]),ae.clickReset)return ae.clickReset=!1;const e=se().getFieldsValue();return e.templateId?e.flowId?e.nodeCode?void le({page:1}):V.warning("请先选择所属节点"):V.warning("请先选择所属版本"):V.warning("请先选择所属流程")},resetFunc:async()=>{se().updateSchema([{field:"flowId",componentProps:{options:[]}},{field:"nodeCode",componentProps:{options:[]}}]),ae.nodeCode="",ae.clickReset=!0}},immediate:!1,tableSetting:{setting:!1,redo:!1},rowSelection:{type:"checkbox"},clickToRowSelect:!1});async function pe(e){ae.batchType=e;const t=de();if(!t.length)return V.error(N("common.selectDataTip"));if(t.some((e=>e.version!==t[0].version)))return V.error("请选择相同的版本审批单");ae.approvalData={...te};const o=t[0],a=(await n(o.flowId,ae.nodeCode)).data||{};if(0!==e&&1!==e){if(2===e){if(!a.hasTransferBtn)return V.error("当前审批节点无转审权限");q(!0,{properties:a,eventType:"transfer"})}if(3==e){if(!a.hasBackBtn)return V.error("当前审批节点无退回权限");ae.allBtnDisabled=!0,l(o.id).then((e=>{ae.allBtnDisabled=!1;const t={backNodeCodeList:e.data.list||[],branchList:[],candidateList:[],taskId:o.id,formData:{flowId:o.flowId,data:{}},eventType:"back",properties:a};O(!0,t)})).catch((()=>{ae.allBtnDisabled=!1}))}}else{if(0===e&&!a.hasAuditBtn)return V.error("当前审批节点无同意权限");if(1===e&&!a.hasRejectBtn)return V.error("当前审批节点无拒绝权限");ae.allBtnDisabled=!0;const t={flowId:o.flowId,operatorId:o.id,batchType:ae.batchType};s(t).then((t=>{const n=t.data;ae.allBtnDisabled=!1,ae.candidateType=n.type;const s=t.data.list.filter((e=>!e.isBranchFlow&&e.isCandidates));O(!0,{branchList:[],candidateList:s,backNodeCodeList:[],taskId:o.id,formData:{flowId:o.flowId,data:{}},eventType:0==e?"audit":"reject",properties:a})})).catch((()=>{ae.allBtnDisabled=!1}))}}function fe(e){ae.approvalData=e,ue()}function ue(e=null){ae.allBtnDisabled=!0;const t={...ae.approvalData,batchType:ae.batchType,candidateType:ae.candidateType,ids:ie()};e&&(t.errorRuleUserList=e),d(t).then((e=>{!function(e){const t=e.data;t&&Array.isArray(t)&&t.length?(ae.allBtnDisabled=!1,A(!0,{errorData:t})):V.success(e.msg).then((()=>{H(),$(),E(),re(),ae.allBtnDisabled=!1,le()}))}(e)})).catch((()=>{ae.allBtnDisabled=!1,G({confirmLoading:!1}),z({confirmLoading:!1})}))}return h((()=>ae.nodeCode),(e=>{e&&re()})),(e,t)=>{const o=w("a-alert"),a=w("a-button"),n=w("a-tag"),s=w("JnpfTextTag");return b(),y(D(r),R(e.$attrs,{onRegister:D(U),title:"批量审批",class:"full-popup"}),{default:C((()=>[_(D(p),{columns:ee,onRegister:D(ne)},{headerTop:C((()=>[_(o,{message:"请先选择所属流程、名称和节点。（同一流程同一节点的审批数据才能使用批量审批）",type:"warning","show-icon":""})])),tableTitle:C((()=>[_(a,{color:"success",disabled:!ae.nodeCode||ae.allBtnDisabled,onClick:t[0]||(t[0]=e=>pe(2))},{default:C((()=>t[4]||(t[4]=[I("批量转审")]))),_:1,__:[4]},8,["disabled"]),_(a,{color:"primary",disabled:!ae.nodeCode||ae.allBtnDisabled,onClick:t[1]||(t[1]=e=>pe(0))},{default:C((()=>t[5]||(t[5]=[I("批量同意")]))),_:1,__:[5]},8,["disabled"]),_(a,{color:"error",disabled:!ae.nodeCode||ae.allBtnDisabled,onClick:t[2]||(t[2]=e=>pe(1))},{default:C((()=>t[6]||(t[6]=[I("批量拒绝")]))),_:1,__:[6]},8,["disabled"]),_(a,{color:"warning",disabled:!ae.nodeCode||ae.allBtnDisabled,onClick:t[3]||(t[3]=e=>pe(3))},{default:C((()=>t[7]||(t[7]=[I("批量退回")]))),_:1,__:[7]},8,["disabled"])])),bodyCell:C((({column:e,record:o})=>["fullName"===e.key?(b(),k(T,{key:0},[o.delegateUser?(b(),y(n,{key:0,color:"success"},{default:C((()=>t[8]||(t[8]=[I("代理")]))),_:1,__:[8]})):B("",!0),I(" "+S(o.fullName),1)],64)):B("",!0),"flowVersion"===e.key?(b(),y(n,{key:1,color:"processing"},{default:C((()=>[I("V:"+S(o.flowVersion),1)])),_:2},1024)):B("",!0),"flowUrgent"===e.key?(b(),y(s,{key:2,content:D(Q)(o.flowUrgent),color:D(W)(o.flowUrgent),showTag:!1,showTextColor:""},null,8,["content","color"])):B("",!0),"status"===e.key?(b(),y(s,{key:3,content:D(X)(o.status),color:D(Z)(o.status)},null,8,["content","color"])):B("",!0)])),_:1},8,["onRegister"]),_(F,{onRegister:D(Y),onConfirm:ue},null,8,["onRegister"]),_(j,{onRegister:D(K),onConfirm:fe},null,8,["onRegister"]),_(P,{onRegister:D(J),onConfirm:fe},null,8,["onRegister"])])),_:1},16,["onRegister"])}}});export{L as _};
