import{b as e,c as a,u as l,d as t}from"./dataModel-ea807f46.js";import{g as i}from"./commonFields-6e52637f.js";import{a as d,B as n}from"./index-9c138ba5.js";import{u as r,B as o}from"./useForm-1d28ee0b.js";import"./componentMap-c91676b4.js";import{d as s,u,ad as p,r as c,M as m,k as y,eg as v,e as k,o as f,p as g,l as h,a4 as b,j as _,g as x,F as w,h as N,m as j,t as T,bN as I,q as L,fG as K,V as U,ah as F,a5 as C}from"./index-920db443.js";import{S as $}from"./sortable.esm-02d0fe44.js";import"./ArrowLeftOutlined-3fbf15bc.js";import"./log-2a5f2c26.js";import"./useTabs-ceeccdba.js";import"./upperFirst-2cd1a2f7.js";import"./uniqBy-e868edd7.js";import"./index-143f5813.js";import"./useWindowSizeFn-05f906e2.js";import"./visualDev-8f54ab4b.js";import"./index.vue_vue_type_script_setup_true_lang-69353133.js";import"./index-999abbee.js";import"./Parser.vue_vue_type_script_setup_true_lang-6ddfe448.js";import"./Item.vue_vue_type_script_setup_true_lang-fef56f78.js";import"./Form.vue_vue_type_script_setup_true_lang-63005a4d.js";import"./createAsyncComponent-7e8f72ac.js";import"./DataLogList.vue_vue_type_script_setup_true_lang-c225eb8c.js";import"./index-0be8277c.js";import"./jquery-6353a699.js";import"./useDefineSetting-7df030ff.js";import"./CustomForm.vue_vue_type_script_setup_true_lang-1aa664f4.js";import"./config-06ca91cd.js";const z={class:"m-10px mb-0"},A={class:"caption"},P={key:0,class:"drag-handler icon-ym icon-ym-darg",title:"点击拖动"},S={key:1},q=C(s({__name:"Form",emits:["register","reload"],setup(s,{emit:C}){const q=C,{createMessage:D}=F(),{t:O}=u(),Z=[{fullName:"字符串",id:"varchar"},{fullName:"整型",id:"int"},{fullName:"日期时间",id:"datetime"},{fullName:"浮点",id:"decimal"},{fullName:"长整型",id:"bigint"},{fullName:"文本",id:"text"}],B=p({value:{table:"",tableName:"",newTable:""}}),M=c(""),R=c(""),E=c(!1),G=c([]),Q=c([]),[V,{setFieldsValue:W,resetFields:H,validate:J}]=r({baseColProps:{span:8},labelWidth:100,schemas:[{field:"newTable",label:"表名称",component:"Input",componentProps:{placeholder:"请输入",maxlength:50},rules:[{required:!0,trigger:"blur",message:"必填"},{pattern:/(^_([A-Za-z0-9]_?)*$)|(^[A-Za-z](_?[A-Za-z0-9])*_?$)/,message:"请输入正确的表名称",trigger:"blur"}]},{field:"tableName",label:"表说明",component:"Input",componentProps:{placeholder:"请输入",maxlength:50},rules:[{required:!0,trigger:"blur",message:"必填"}]}]}),X=m((()=>{let e=[{title:"拖动",dataIndex:"drag",key:"drag",align:"center",width:50},{width:50,title:"序号",align:"center",customRender:({index:e})=>e+1},{title:"列名",dataIndex:"field",key:"field"},{title:"类型",dataIndex:"dataType",key:"dataType",width:200},{title:"长度",dataIndex:"dataLength",key:"dataLength"},{title:"是否主键",dataIndex:"primaryKey",key:"primaryKey",align:"center",width:80},{title:"自增长ID",dataIndex:"identity",key:"identity",align:"center",width:80},{title:"允许空",dataIndex:"allowNull",key:"allowNull",align:"center",width:80},{title:"说明",dataIndex:"fieldName",key:"fieldName"},{title:"操作",dataIndex:"action",key:"action",width:50}];return["Oracle","PostgreSQL","KingbaseES"].includes(R.value)&&(e=e.filter((e=>"identity"!=e.key))),e})),[Y,{closePopup:ee,changeLoading:ae,changeOkLoading:le}]=d((function(a){B.value.table=a.table,M.value=a.linkId,R.value=a.dbType,G.value=[],void i().then((e=>{Q.value=e.data.list})),ae(!0),H(),B.value.table?e(y(M),B.value.table).then((e=>{B.value=e.data.tableInfo,B.value.newTable=B.value.table,W(B.value);let a=e.data.tableFieldList.map((e=>({...e,index:v(),primaryKey:!!e.primaryKey,allowNull:!!e.allowNull,identity:!!e.identity})));E.value=e.data.hasTableData||!1,E.value&&(a=a.map((e=>({...e,disabled:!0})))),G.value=a,ae(!1)})):(E.value=!1,B.value.newTable=a.table||"",ae(!1));!function(){const e=document.querySelector(".drag-table .ant-table-tbody");$.create(e,{handle:".drag-handler",animation:150,easing:"cubic-bezier(1, 0, 0, 1)",onStart:()=>{},onEnd:({newIndex:e,oldIndex:a})=>{ie(G.value,a,e)}})}()})),te=m((()=>y(B.value.table)?O("common.editText"):O("common.addText")));const ie=(e,a,l)=>{const t=e.splice(a,1)[0];e.splice(l,0,t)};function de(e=void 0){const a=v();let l={};l=e?{field:e.field,dataType:e.dataType,dataLength:e.dataLength,allowNull:!!e.allowNull,fieldName:e.fieldName,primaryKey:!1,index:a}:{field:"",dataType:"varchar",dataLength:50,allowNull:!0,primaryKey:!1,fieldName:"",index:a},G.value.push(l)}async function ne(){const e=await J();if(!e)return;if(!G.value.length)return D.error("请至少添加一个字段");if(!function(){let e=!0;for(let a=0;a<G.value.length;a++){const l=G.value[a];if(!l.field){D.error(`第${a+1}行列名不能为空`),e=!1;break}const t=/^\d+,?\d*$/;if(!/(^_([a-zA-Z0-9]_?)*$)|(^[a-zA-Z](_?[a-zA-Z0-9])*_?$)/.test(l.field)){D.error(`第${a+1}行列名格式错误，请重新输入`),e=!1;break}if(G.value.filter((e=>e.field==l.field)).length>1){D.error(`第${a+1}行列名'${l.field}'已重复`),e=!1;break}if(!t.test(l.dataLength)){D.error(`第${a+1}行请输入数字`),e=!1;break}if(!l.fieldName){D.error(`第${a+1}行说明不能为空`),e=!1;break}}return e}())return;if(!G.value.some((e=>e.primaryKey)))return D.error("请选择一个字段作为主键");le(!0);const i={...B.value,...e},d={tableFieldList:(E.value?G.value.filter((e=>!e.disabled)):G.value).map((e=>({...e,primaryKey:e.primaryKey?1:0,allowNull:e.allowNull?1:0,identity:e.identity&&e.primaryKey?1:0}))),tableInfo:i};(E.value?a:B.value.table?l:t)(y(M),d).then((e=>{D.success(e.msg),le(!1),ee(),setTimeout((()=>{q("reload")}),200)})).catch((()=>{le(!1)}))}return(e,a)=>{const l=k("a-menu-item"),t=k("a-menu"),i=k("a-button"),d=k("a-dropdown"),r=k("a-checkbox"),s=k("a-input"),u=k("a-input-number"),p=k("jnpf-select"),c=k("a-table");return f(),g(y(n),U(e.$attrs,{onRegister:y(Y),title:te.value,showOkBtn:"",onOk:ne}),{default:h((()=>[b("div",z,[_(y(o),{onRegister:y(V)},null,8,["onRegister"])]),b("div",A,[a[2]||(a[2]=b("p",{class:"title"},"字段设置",-1)),_(d,{disabled:!Q.value.length},{overlay:h((()=>[_(t,null,{default:h((()=>[(f(!0),x(w,null,N(Q.value,(e=>(f(),g(l,{key:e.field,onClick:a=>de(e)},{default:h((()=>[j(T(e.field),1)])),_:2},1032,["onClick"])))),128))])),_:1})])),default:h((()=>[_(i,null,{default:h((()=>[a[1]||(a[1]=j("常用字段")),_(y(I))])),_:1,__:[1]})])),_:1},8,["disabled"])]),_(c,{"data-source":G.value,columns:X.value,size:"small",pagination:!1,rowKey:"index",class:"drag-table"},{bodyCell:h((({column:e,record:l,index:t})=>["drag"===e.key?(f(),x("i",P)):L("",!0),l.disabled?(f(),x(w,{key:1},[["primaryKey","allowNull"].includes(e.key)?(f(),g(r,{key:0,checked:l[e.key]},null,8,["checked"])):L("",!0),"dataType"===e.key?(f(),x(w,{key:1},[j(T(y(K)(l[e.key])),1)],64)):L("",!0)],64)):(f(),x(w,{key:2},["field"===e.key?(f(),g(s,{key:0,value:l.field,"onUpdate:value":e=>l.field=e,placeholder:"请输入",maxlength:50},null,8,["value","onUpdate:value"])):L("",!0),"dataLength"===e.key?(f(),x(w,{key:1},["decimal"==l.dataType?(f(),g(s,{key:0,value:l.dataLength,"onUpdate:value":e=>l.dataLength=e,placeholder:"请输入"},null,8,["value","onUpdate:value"])):(f(),g(u,{key:1,value:l.dataLength,"onUpdate:value":e=>l.dataLength=e,placeholder:"请输入",disabled:"varchar"!==l.dataType&&"decimal"!==l.dataType},null,8,["value","onUpdate:value","disabled"]))],64)):L("",!0),"dataType"===e.key?(f(),g(p,{key:2,value:l.dataType,"onUpdate:value":e=>l.dataType=e,placeholder:"请选择",options:Z},null,8,["value","onUpdate:value"])):L("",!0),"primaryKey"===e.key?(f(),g(r,{key:3,checked:l.primaryKey,"onUpdate:checked":e=>l.primaryKey=e,onChange:e=>{return(a=l).identity=!1,void(a.allowNull=!1);var a}},null,8,["checked","onUpdate:checked","onChange"])):L("",!0),"identity"===e.key?(f(),x(w,{key:4},[l.primaryKey?(f(),g(r,{key:0,checked:l.identity,"onUpdate:checked":e=>l.identity=e},null,8,["checked","onUpdate:checked"])):(f(),x("span",S))],64)):L("",!0),"allowNull"===e.key?(f(),g(r,{key:5,checked:l.allowNull,"onUpdate:checked":e=>l.allowNull=e,disabled:!!l.primaryKey},null,8,["checked","onUpdate:checked","disabled"])):L("",!0),"fieldName"===e.key?(f(),g(s,{key:6,value:l.fieldName,"onUpdate:value":e=>l.fieldName=e,placeholder:"请输入",maxlength:50},null,8,["value","onUpdate:value"])):L("",!0)],64)),"action"===e.key?(f(),x(w,{key:3},[l.disabled?L("",!0):(f(),g(i,{key:0,class:"action-btn",type:"link",color:"error",onClick:e=>function(e){G.value.splice(e,1)}(t),size:"small"},{default:h((()=>a[3]||(a[3]=[j("删除")]))),_:2,__:[3]},1032,["onClick"]))],64)):L("",!0)])),_:1},8,["data-source","columns"]),b("div",{class:"table-add-action",onClick:a[0]||(a[0]=e=>de())},[_(i,{type:"link",preIcon:"icon-ym icon-ym-btn-add"},{default:h((()=>a[4]||(a[4]=[j("新增一行")]))),_:1,__:[4]})])])),_:1},16,["onRegister","title"])}}}),[["__scopeId","data-v-1863a189"]]);export{q as default};
