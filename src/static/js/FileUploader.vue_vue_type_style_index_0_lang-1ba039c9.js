import{d as e,aw as a,r as l,ad as t,dD as i,a7 as s,n,e as o,o as r,g as u,p as c,l as d,j as p,k as f,m,i as y,a4 as h,F as g,h as k,af as v,hx as _,q as S,v as x,hy as F,hz as U,eg as w,ah as z}from"./index-920db443.js";import{d as q}from"./document-763aa4ad.js";const A={id:"document-file-uploader"},C={class:"file-panel"},T={class:"upload-file-list"},B=e({__name:"FileUploader",props:{parentId:{type:String,default:"0"}},emits:["fileSuccess"],setup(e,{expose:B,emit:I}){const R=F.Uploader,j=F.UploaderBtn,N=F.UploaderUnsupport,b=F.UploaderList,D=F.UploaderFile,E=e,O=I,{createMessage:J}=z(),L=a(),M=l(null),$=l(null),P=t({target:L.apiUrl+"/api/file/chunk",chunkSize:5242880,maxChunkRetries:5,singleFile:!1,testChunks:!0,checkChunkUploadedByResponse:function(e,a){const l=JSON.parse(a);if(200===l.code){if(l.data.uploaded)return!0;return(l.data.chunkNumbers||[]).indexOf(e.offset+1)>=0}return!0},headers:{Authorization:i()},query:{fileType:"",extension:""}}),G={accept:"*"},H={success:"上传成功",error:"上传失败",uploading:"上传中",paused:"暂停中",waiting:"等待中"},K=l(!1),Q=l(+new Date);function V(e){e.customStatus="check",K.value=!0,P.query.fileType=e.fileType,P.query.extension=e.getExtension(),function(e){const a=new FileReader,l=File.prototype.slice||File.prototype.mozSlice||File.prototype.webkitSlice;let t=0;const i=1024e4,s=Math.ceil(e.size/i),n=new U.ArrayBuffer;function o(){const s=t*i,n=s+i>=e.size?e.size:s+i;a.readAsArrayBuffer(l.call(e.file,s,n))}e.pause(),o(),a.onload=a=>{if(n.append(a.target?.result),t<s)t++,o();else{!function(e,a){a.uniqueIdentifier=e+w(),a.customStatus="uploading",a.resume()}(n.end(),e)}},a.onerror=function(){J.error(`文件${e.name}读取出错，请检查该文件`),e.cancel()}}(e)}function W(e,a,l,t){const i=JSON.parse(l);if(200!=i.code)return J.error(i.msg),void a.cancel();setTimeout((()=>{i.data.uploaded||(i.data.merge?function(e){const a={identifier:e.uniqueIdentifier,fileName:e.name.replaceAll("#",""),fileSize:e.size,fileType:e.getType(),extension:e.getExtension(),parentId:E.parentId};q(a).then((a=>{e.customCompleted=!0,O("fileSuccess",a.data),e.cancel()})).catch((()=>{e.cancel()}))}(a):(a.cancel(),J.error("上传失败")))}),300)}function X(e,a,l){}function Y(e,a,l,t){a.cancel(),J.error("上传失败")}function Z(){M.value?.uploader.cancel(),K.value=!1,Q.value=+new Date}return B({openUploader:function(){$.value.$el.click()}}),s((()=>{n((()=>{window.uploader=M.value?.uploader}))})),(e,a)=>{const l=o("jnpf-empty");return r(),u("div",A,[(r(),c(f(R),{options:P,"file-status-text":H,class:"uploader-app",ref_key:"uploaderRef",ref:M,onFileAdded:V,onFileSuccess:W,onFileProgress:X,onFileError:Y,onComplete:Z,autoStart:!1,key:Q.value},{default:d((()=>[p(f(N)),p(f(j),{id:"file-uploader-btn",ref_key:"uploaderBtnRef",ref:$,attrs:G},{default:d((()=>a[0]||(a[0]=[m("选择文件")]))),_:1,__:[0]},512),y(p(f(b),null,{default:d((({fileList:e})=>[h("div",C,[h("div",{class:"file-title"},[a[1]||(a[1]=h("p",{class:"title"},"上传文件列表",-1)),h("div",{class:"operate"},[h("i",{class:"icon-ym icon-ym-nav-close",onClick:Z})])]),h("div",T,[(r(!0),u(g,null,k(e,(e=>(r(),u("div",{class:"upload-file-list__item",key:e.id},[p(f(D),{class:v("file_"+e.id),ref_for:!0,ref:"files",file:e,list:!0},{default:d((e=>[p(_,{file:e.file,list:e.list},null,8,["file","list"])])),_:2},1032,["class","file"])])))),128)),e.length?S("",!0):(r(),c(l,{key:0,description:"暂无待上传文件"}))])])])),_:1},512),[[x,K.value]])])),_:1},8,["options"]))])}}});export{B as _};
