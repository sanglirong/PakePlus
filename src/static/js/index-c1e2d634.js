import{d as e,r as t,ad as a,a0 as s,aw as o,M as r,a7 as i,a8 as n,e as p,a9 as l,o as u,g as d,i as m,k as c,p as _,l as j,j as g,a4 as f,q as h,F as v,aA as y,f1 as x,n as I,f2 as w,f3 as b}from"./index-920db443.js";import{u as S,B as k}from"./useForm-1d28ee0b.js";import"./componentMap-c91676b4.js";import{u as A,i as D,_ as P,g as L}from"./index.vue_vue_type_style_index_0_scoped_ab412ce5_lang-e8f5a437.js";import{u as U}from"./index-143f5813.js";import"./index-c37d2476.js";import"./vuedraggable.umd-11acc51f.js";/* empty css                                                                     *//* empty css                                                     */import"./sortable.esm-02d0fe44.js";import"./config-06ca91cd.js";import"./dataMap-47db3937.js";import"./index-fea1d737.js";import"./useTabs-ceeccdba.js";import"./upperFirst-2cd1a2f7.js";import"./log-2a5f2c26.js";import"./uniqBy-e868edd7.js";import"./visualDev-8f54ab4b.js";import"./index.vue_vue_type_script_setup_true_lang-69353133.js";import"./index-9c138ba5.js";import"./ArrowLeftOutlined-3fbf15bc.js";import"./index-999abbee.js";import"./Parser.vue_vue_type_script_setup_true_lang-6ddfe448.js";import"./Item.vue_vue_type_script_setup_true_lang-fef56f78.js";import"./Form.vue_vue_type_script_setup_true_lang-63005a4d.js";import"./createAsyncComponent-7e8f72ac.js";import"./DataLogList.vue_vue_type_script_setup_true_lang-c225eb8c.js";import"./index-0be8277c.js";import"./jquery-6353a699.js";import"./useDefineSetting-7df030ff.js";import"./CustomForm.vue_vue_type_script_setup_true_lang-1aa664f4.js";import"./useWindowSizeFn-05f906e2.js";import"./BasicLeftTree-cd55d444.js";import"./useTable-dc8c9d84.js";import"./SettingOutlined-dd6150a2.js";import"./index-1cfe4e28.js";import"./billRule-0363563b.js";import"./import-e198d900.js";import"./tip-b30e67af.js";import"./dataSource-ed26da12.js";import"./dataModel-ea807f46.js";import"./index-3b5bee70.js";import"./CopyOutlined-8d46c8b2.js";const R={class:"jnpf-content-wrapper jnpf-dynamicReport-wrapper"},q={key:0,class:"tool-wrap"},C={key:1,class:"query-wrap"},E={class:"content-main"},F=e({name:"dynamicReport",__name:"index",setup(e){const F=t(),N=a({id:"",reportData:{},pageLoading:!1,jnpfUniverAPI:null,allowExport:0,allowPrint:0,sheetId:"",jnpfUniverKey:0,queryList:[]}),{pageLoading:O,allowExport:M,allowPrint:B,jnpfUniverKey:J}=s(N),[W,{openModal:z}]=U(),[K,{updateSchema:T,submit:G,getFieldsValue:H}]=S({baseColProps:{span:6},showActionButtonGroup:!0,showAdvancedButton:!0,compact:!0}),V={updateSchema:T,getFieldsValue:H},{getRealEchart:X,getSearchSchema:Q,searchSchemas:Y}=A(V),Z=o(),$=r((()=>!(!N.allowExport&&!N.allowPrint)));function ee(e={}){N.pageLoading=!0,x(N.id,e).then((e=>{N.reportData=e.data,N.allowExport=e.data.allowExport||0,N.allowPrint=e.data.allowPrint||0,N.queryList=e.data.queryList?JSON.parse(e.data.queryList):[];const t=e.data.snapshot?JSON.parse(e.data.snapshot):null,a=e.data.cells?JSON.parse(e.data.cells):{},s=e.data.chartData?JSON.parse(e.data.chartData):[],o=X(a.floatEcharts??null,s);let r=a.floatImages||{},i=L(t.resources,Z.reportApiUrl,r);t.resources=i.list,r=i?.floatImages||{},Q(N.queryList,N.sheetId||""),N.jnpfUniverKey=+new Date,I((()=>{!function(e,t,a){const s=c(F)?.handleCreateDesignUnit({mode:"preview",snapshot:e,floatEcharts:t,floatImages:a,uiHeader:!1,uiContextMenu:!1,workbookReadonly:!0,defaultActiveSheetId:N.sheetId||"",loading:!0});N.jnpfUniverAPI=s?s?.jnpfUniverAPI:null,N.jnpfUniverAPI?.onCommandExecuted((e=>{const{id:t}=e??{};"sheet.operation.set-worksheet-active"===t&&(N.sheetId=e.params.subUnitId,Q(N.queryList,N.sheetId))}))}(t,o,r)})),N.pageLoading=!1}))}function te(e){ee({sheetId:N.sheetId,...e})}function ae(){const{snapshot:e}=c(F)?.getPreviewWorkbookData(),t=N.jnpfUniverAPI.getActiveWorkbook()?.getActiveSheet()?.getSheetId(),a=c(F)?.getActiveWorksheetId(),{xSplit:s=0,ySplit:o=0}=e?.sheets?.[a]?.freeze??{},r=s>0,i=o>0;z(!0,{id:N.reportData.versionId,fullName:N.reportData.fullName,sheetId:t,snapshot:e,hasXFreeze:r,hasYFreeze:i})}function se(){const{snapshot:e}=c(F)?.getPreviewWorkbookData(),t=N.jnpfUniverAPI.getActiveWorkbook()?.getActiveSheet()?.getSheetId(),a={...c(Y).length?H():{},sheetId:t,fullName:N.reportData.fullName,snapshot:e?JSON.stringify(e):null};w(N.reportData.versionId,a).then((e=>{b({url:e.data.url})}))}return i((()=>{!function(){const e=y();N.id=e?.meta?.relationId,N.id&&(N.pageLoading=!0,ee())}()})),n((()=>{c(F)?.handleDisposeUnit()})),(e,t)=>{const a=p("a-button"),s=p("a-tooltip"),o=l("loading");return u(),d(v,null,[m((u(),d("div",R,[$.value?(u(),d("div",q,[c(B)?(u(),_(s,{key:0,title:"打印"},{default:j((()=>[g(a,{type:"text",disabled:c(O),class:"action-bar-btn",onClick:ae},{default:j((()=>t[0]||(t[0]=[f("i",{class:"icon-ym icon-ym-printExample"},null,-1)]))),_:1,__:[0]},8,["disabled"])])),_:1})):h("",!0),c(M)?(u(),_(s,{key:1,title:"导出"},{default:j((()=>[g(a,{type:"text",disabled:c(O),class:"action-bar-btn",onClick:se},{default:j((()=>t[1]||(t[1]=[f("i",{class:"icon-ym icon-ym-btn-export1"},null,-1)]))),_:1,__:[1]},8,["disabled"])])),_:1})):h("",!0)])):h("",!0),c(Y)?.length?(u(),d("div",C,[g(c(k),{onRegister:c(K),schemas:c(Y),onSubmit:te,onReset:c(G),class:"search-form"},null,8,["onRegister","schemas","onReset"])])):h("",!0),f("div",E,[(u(),_(c(D),{ref_key:"jnpfUniverRef",ref:F,key:c(J)}))])])),[[o,c(O)]]),g(c(P),{onRegister:c(W)},null,8,["onRegister"])],64)}}});export{F as default};
